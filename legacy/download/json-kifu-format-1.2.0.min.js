var JSONKifuFormat=function(r){function t(o){if(e[o])return e[o].exports;var n=e[o]={i:o,l:!1,exports:{}};return r[o].call(n.exports,n,n.exports,t),n.l=!0,n.exports}var e={};return t.m=r,t.c=e,t.d=function(r,e,o){t.o(r,e)||Object.defineProperty(r,e,{configurable:!1,enumerable:!0,get:o})},t.n=function(r){var e=r&&r.__esModule?function(){return r.default}:function(){return r};return t.d(e,"a",e),e},t.o=function(r,t){return Object.prototype.hasOwnProperty.call(r,t)},t.p="",t(t.s=3)}([function(r,t){r.exports=function(r){function t(o){if(e[o])return e[o].exports;var n=e[o]={i:o,l:!1,exports:{}};return r[o].call(n.exports,n,n.exports,t),n.l=!0,n.exports}var e={};return t.m=r,t.c=e,t.d=function(r,e,o){t.o(r,e)||Object.defineProperty(r,e,{configurable:!1,enumerable:!0,get:o})},t.n=function(r){var e=r&&r.__esModule?function(){return r.default}:function(){return r};return t.d(e,"a",e),e},t.o=function(r,t){return Object.prototype.hasOwnProperty.call(r,t)},t.p="",t(t.s=3)}([function(r,t,e){"use strict";t.__esModule=!0;var o;!function(r){r[r.Black=0]="Black",r[r.White=1]="White"}(o||(o={})),t.default=o},function(r,t,e){"use strict";t.__esModule=!0;var o=e(0),n=" *  *  *  *  *  *  *  *  * ",u=["-FU-FU-FU-FU-FU-FU-FU-FU-FU",n,n,n,"+FU+FU+FU+FU+FU+FU+FU+FU+FU"," * +KA *  *  *  *  * +HI * ","+KY+KE+GI+KI+OU+KI+GI+KE+KY"],i=[n].concat(u);t.PRESET={HIRATE:{board:["-KY-KE-GI-KI-OU-KI-GI-KE-KY"," * -HI *  *  *  *  * -KA * "].concat(u),turn:o.default.Black},KY:{board:["-KY-KE-GI-KI-OU-KI-GI-KE * "," * -HI *  *  *  *  * -KA * "].concat(u),turn:o.default.White},KY_R:{board:[" * -KE-GI-KI-OU-KI-GI-KE-KY"," * -HI *  *  *  *  * -KA * "].concat(u),turn:o.default.White},KA:{board:["-KY-KE-GI-KI-OU-KI-GI-KE-KY"," * -HI *  *  *  *  *  *  * "].concat(u),turn:o.default.White},HI:{board:["-KY-KE-GI-KI-OU-KI-GI-KE-KY"," *  *  *  *  *  *  * -KA * "].concat(u),turn:o.default.White},HIKY:{board:["-KY-KE-GI-KI-OU-KI-GI-KE * "," *  *  *  *  *  *  * -KA * "].concat(u),turn:o.default.White},2:{board:["-KY-KE-GI-KI-OU-KI-GI-KE-KY"].concat(i),turn:o.default.White},3:{board:["-KY-KE-GI-KI-OU-KI-GI-KE * "].concat(i),turn:o.default.White},4:{board:[" * -KE-GI-KI-OU-KI-GI-KE * "].concat(i),turn:o.default.White},5:{board:[" *  * -GI-KI-OU-KI-GI-KE * "].concat(i),turn:o.default.White},"5_L":{board:[" * -KE-GI-KI-OU-KI-GI *  * "].concat(i),turn:o.default.White},6:{board:[" *  * -GI-KI-OU-KI-GI *  * "].concat(i),turn:o.default.White},8:{board:[" *  *  * -KI-OU-KI *  *  * "].concat(i),turn:o.default.White},10:{board:[" *  *  *  * -OU *  *  *  * "].concat(i),turn:o.default.White}};var a=[0,-1],c=[0,1],s=[1,0],f=[-1,0],l=[-1,-1],h=[1,-1],p=[-1,1],d=[1,1],v={just:[l,a,h,f,s,c]};t.MOVE_DEF={FU:{just:[a]},KY:{fly:[a]},KE:{just:[[-1,-2],[1,-2]]},GI:{just:[l,a,h,p,d]},KI:v,TO:v,NY:v,NK:v,NG:v,KA:{fly:[l,h,p,d]},HI:{fly:[a,f,s,c]},OU:{just:[l,a,h,f,s,p,c,d]},UM:{fly:[l,h,p,d],just:[a,f,s,c]},RY:{fly:[a,f,s,c],just:[l,h,p,d]}}},function(r,t,e){"use strict";t.__esModule=!0;var o=e(0),n=function(){function r(r){this.color="+"===r.slice(0,1)?o.default.Black:o.default.White,this.kind=r.slice(1)}return r.promote=function(r){return{FU:"TO",KY:"NY",KE:"NK",GI:"NG",KA:"UM",HI:"RY"}[r]||r},r.unpromote=function(r){return{TO:"FU",NY:"KY",NK:"KE",NG:"GI",KI:"KI",UM:"KA",RY:"HI",OU:"OU"}[r]||r},r.canPromote=function(t){return r.promote(t)!==t},r.isPromoted=function(r){return["TO","NY","NK","NG","UM","RY"].indexOf(r)>=0},r.oppositeColor=function(r){return r===o.default.Black?o.default.White:o.default.Black},r.fromSFENString=function(t){var e="+"===t[0];e&&(t=t.slice(1));var o=t.match(/[A-Z]/)?"+":"-",n={P:"FU",L:"KY",N:"KE",S:"GI",G:"KI",B:"KA",R:"HI",K:"OU"}[t.toUpperCase()],u=new r(o+n);return e&&u.promote(),u},r.prototype.promote=function(){this.kind=r.promote(this.kind)},r.prototype.unpromote=function(){this.kind=r.unpromote(this.kind)},r.prototype.inverse=function(){this.color=this.color===o.default.Black?o.default.White:o.default.Black},r.prototype.toCSAString=function(){return(this.color===o.default.Black?"+":"-")+this.kind},r.prototype.toSFENString=function(){var t={FU:"P",KY:"L",KE:"N",GI:"S",KI:"G",KA:"B",HI:"R",OU:"K"}[r.unpromote(this.kind)];return(r.isPromoted(this.kind)?"+":"")+(this.color===o.default.Black?t:t.toLowerCase())},r}();t.default=n},function(r,t,e){"use strict";t.__esModule=!0;/** @license
 * Shogi.js
 * Copyright (c) 2014 na2hiro (https://github.com/na2hiro)
 * This software is released under the MIT License.
 * http://opensource.org/licenses/mit-license.php
 */
var o=e(0);t.Color=o.default;var n=e(1),u=e(2);t.Piece=u.default,e(4);var i=e(5),a=function(){function r(r){this.initialize(r)}return r.getIllegalUnpromotedRow=function(r){switch(r){case"FU":case"KY":return 1;case"KE":return 2;default:return 0}},r.getRowToOppositeEnd=function(r,t){return t===o.default.Black?r:10-r},r.prototype.initialize=function(r){void 0===r&&(r={preset:"HIRATE"}),i.fromPreset(this,r),this.flagEditMode=!1},r.prototype.initializeFromSFENString=function(r){i.fromSfen(this,r)},r.prototype.toCSAString=function(){return i.toCSA(this)},r.prototype.toSFENString=function(r){return void 0===r&&(r=1),i.toSfen(this,r)},r.prototype.editMode=function(r){this.flagEditMode=r},r.prototype.move=function(t,e,o,n,u){void 0===u&&(u=!1);var i=this.get(t,e);if(null==i)throw new Error("no piece found at "+t+", "+e);if(this.checkTurn(i.color),!this.flagEditMode&&!this.getMovesFrom(t,e).some(function(r){return r.to.x===o&&r.to.y===n}))throw new Error("cannot move from "+t+", "+e+" to "+o+", "+n);null!=this.get(o,n)&&this.capture(o,n);var a=r.getIllegalUnpromotedRow(i.kind)>=r.getRowToOppositeEnd(n,i.color);(u||a)&&i.promote(),this.set(o,n,i),this.set(t,e,null),this.nextTurn()},r.prototype.unmove=function(r,t,e,o,n,i){void 0===n&&(n=!1);var a=this.get(e,o);if(null==a)throw new Error("no piece found at "+e+", "+o);this.checkTurn(u.default.oppositeColor(a.color));var c;i&&(c=this.popFromHand(u.default.unpromote(i),a.color),c.inverse());var s=this.flagEditMode;this.editMode(!0),this.move(e,o,r,t),n&&a.unpromote(),i&&(u.default.isPromoted(i)&&c.promote(),this.set(e,o,c)),this.editMode(s),this.prevTurn()},r.prototype.drop=function(r,t,e,o){if(void 0===o&&(o=this.turn),this.checkTurn(o),null!=this.get(r,t))throw new Error("there is a piece at "+r+", "+t);if(!this.getDropsBy(o).some(function(o){return o.to.x===r&&o.to.y===t&&o.kind===e}))throw new Error("Cannot move");var n=this.popFromHand(e,o);this.set(r,t,n),this.nextTurn()},r.prototype.undrop=function(r,t){var e=this.get(r,t);if(null==e)throw new Error("there is no piece at "+r+", "+t);this.checkTurn(u.default.oppositeColor(e.color)),this.pushToHand(e),this.set(r,t,null),this.prevTurn()},r.prototype.getMovesFrom=function(r,t){var e=function(r,t,e){if(r<1||9<r||t<1||9<t)return!1;var o=this.get(r,t);return null==o||o.color!==e}.bind(this),u=function(r,t,e){var o=this.get(r,t);return null!=o&&o.color!==e}.bind(this),i=this.get(r,t);if(null==i)return[];var a=n.MOVE_DEF[i.kind],c=[],s={x:r,y:t},f=i.color===o.default.Black?1:-1;if(a.just)for(var l=0,h=a.just;l<h.length;l++){var p=h[l],d={x:s.x+p[0]*f,y:s.y+p[1]*f};e(d.x,d.y,i.color)&&c.push({from:s,to:d})}if(a.fly)for(var v=0,m=a.fly;v<m.length;v++)for(var p=m[v],d={x:s.x+p[0]*f,y:s.y+p[1]*f};e(d.x,d.y,i.color)&&(c.push({from:s,to:{x:d.x,y:d.y}}),!u(d.x,d.y,i.color));)d.x+=p[0]*f,d.y+=p[1]*f;return c},r.prototype.getDropsBy=function(t){for(var e=[],o=[],n=[],u=1;u<=9;u++){for(var i=!1,a=1;a<=9;a++){var c=this.get(u,a);null==c?o.push({x:u,y:a}):c.color===t&&"FU"===c.kind&&(i=!0)}n.push(i)}for(var s={},f=0,l=this.hands[t];f<l.length;f++){var h=l[f],p=h.kind;if(!s[p]){s[p]=!0;for(var d=r.getIllegalUnpromotedRow(p),v=0,m=o;v<m.length;v++){var g=m[v];"FU"===p&&n[g.x-1]||d>=r.getRowToOppositeEnd(g.y,t)||e.push({to:g,color:t,kind:p})}}}return e},r.prototype.getMovesTo=function(r,t,e,o){void 0===o&&(o=this.turn);for(var n={x:r,y:t},u=[],i=1;i<=9;i++)for(var a=1;a<=9;a++){var c=this.get(i,a);if(c&&c.kind===e&&c.color===o){var s=this.getMovesFrom(i,a);s.some(function(e){return e.to.x===r&&e.to.y===t})&&u.push({from:{x:i,y:a},to:n})}}return u},r.prototype.get=function(r,t){return this.board[r-1][t-1]},r.prototype.getHandsSummary=function(r){for(var t={FU:0,KY:0,KE:0,GI:0,KI:0,KA:0,HI:0},e=0,o=this.hands[r];e<o.length;e++)t[o[e].kind]++;return t},r.prototype.captureByColor=function(r,t,e){if(!this.flagEditMode)throw new Error("cannot edit board without editMode");var o=this.get(r,t);this.set(r,t,null),o.unpromote(),o.color!==e&&o.inverse(),this.pushToHand(o)},r.prototype.flip=function(r,t){if(!this.flagEditMode)throw new Error("cannot edit board without editMode");var e=this.get(r,t);return!!e&&(u.default.isPromoted(e.kind)?(e.unpromote(),e.inverse()):u.default.canPromote(e.kind)?e.promote():e.inverse(),!0)},r.prototype.setTurn=function(r){if(!this.flagEditMode)throw new Error("cannot set turn without editMode");this.turn=r},r.prototype.set=function(r,t,e){this.board[r-1][t-1]=e},r.prototype.capture=function(r,t){var e=this.get(r,t);this.set(r,t,null),e.unpromote(),e.inverse(),this.pushToHand(e)},r.prototype.pushToHand=function(r){this.hands[r.color].push(r)},r.prototype.popFromHand=function(r,t){for(var e=this.hands[t],o=0;o<e.length;o++)if(e[o].kind===r){var n=e[o];return e.splice(o,1),n}throw new Error(t+" has no "+r)},r.prototype.nextTurn=function(){this.flagEditMode||(this.turn=this.turn===o.default.Black?o.default.White:o.default.Black)},r.prototype.prevTurn=function(){this.flagEditMode||this.nextTurn()},r.prototype.checkTurn=function(r){if(!this.flagEditMode&&r!==this.turn)throw new Error("cannot move opposite piece")},r}();t.Shogi=a},function(r,t,e){"use strict";t.__esModule=!0,Array.prototype.some||(Array.prototype.some=function(r){if(null==this)throw new TypeError;var t=Object(this),e=t.length>>>0;if("function"!=typeof r)throw new TypeError;for(var o=arguments[1],n=0;n<e;n++)if(n in t&&r.call(o,t[n],n,t))return!0;return!1})},function(r,t,e){"use strict";function o(r,t){var e,o=[],n=[[],[]];if("OTHER"!==t.preset){for(var u=0;u<9;u++){o[u]=[];for(var i=0;i<9;i++){var f=c.PRESET[t.preset].board[i].slice(24-3*u,24-3*u+3);o[u][i]=" * "===f?null:new s.default(f)}}e=c.PRESET[t.preset].turn}else{for(var u=0;u<9;u++){o[u]=[];for(var i=0;i<9;i++){var l=t.data.board[u][i];o[u][i]=l.kind?new s.default((l.color===a.default.Black?"+":"-")+l.kind):null}}e=t.data.color;for(var h=0;h<2;h++)for(var p in t.data.hands[h])if(t.data.hands[h].hasOwnProperty(p))for(var f=(0===h?"+":"-")+p,u=0;u<t.data.hands[h][p];u++)n[h].push(new s.default(f))}r.board=o,r.turn=e,r.hands=n}function n(r){for(var t=[],e=0;e<9;e++){for(var o="P"+(e+1),n=8;n>=0;n--){var u=r.board[n][e];o+=null==u?" * ":u.toCSAString()}t.push(o)}for(var i=0;i<2;i++){for(var o="P"+"+-"[i],c=0,s=r.hands[i];c<s.length;c++)o+="00"+s[c].kind;t.push(o)}return t.push(r.turn===a.default.Black?"+":"-"),t.join("\n")}function u(r,t){for(var e=[],o=0;o<9;o++){e[o]=[];for(var n=0;n<9;n++)e[o][n]=null}for(var u=t.split(" "),i=u[0],c=8,f=0,o=0;o<i.length;o++){var l=i[o];"+"===l&&(o++,l+=i[o]),l.match(/^[1-9]$/)?c-=Number(l):"/"===l?(f++,c=8):(e[c][f]=s.default.fromSFENString(l),c--)}r.board=e,r.turn="b"===u[1]?a.default.Black:a.default.White;var h=[[],[]],p=u[2];if("-"!==p)for(;p.length>0;){var d=1,v=p.match(/^[0-9]+/);v&&(d=Number(v[0]),p=p.slice(v[0].length));for(var o=0;o<d;o++){var m=s.default.fromSFENString(p[0]);h[m.color].push(m)}p=p.slice(1)}r.hands=h}function i(r,t){for(var e=[],o=[],n=0;n<9;n++){for(var u="",i=0,c=8;c>=0;c--){var s=r.board[c][n];null==s?i++:(i>0&&(u+=""+i,i=0),u+=s.toSFENString())}i>0&&(u+=""+i),o.push(u)}if(e.push(o.join("/")),e.push(r.turn===a.default.Black?"b":"w"),0===r.hands[0].length&&0===r.hands[1].length)e.push("-");else{for(var f="",l=["R","B","G","S","N","L","P","r","b","g","s","n","l","p"],h={},p=0;p<2;p++)for(var d=0,v=r.hands[p];d<v.length;d++){var m=v[d],g=m.toSFENString();h[g]=(h[g]||0)+1}for(var A=0,k=l;A<k.length;A++){var y=k[A];h[y]>0&&(f+=(h[y]>1?h[y]:"")+y)}e.push(f)}return e.push(""+t),e.join(" ")}t.__esModule=!0;var a=e(0),c=e(1),s=e(2);t.fromPreset=o,t.toCSA=n,t.fromSfen=u,t.toSfen=i}])},function(r,t,e){"use strict";function o(r,t){return t===F.Color.Black?r.y<=3:r.y>=7}function n(r){return u(new F.Shogi(r.initial||void 0),r.moves),r}function u(r,t,e){for(var n=0;n<t.length;n++){var i=0===n?e:t[n-1],a=t[n].move;if(a)if(a.color=r.turn,a.from){i&&i.move&&a.to.x===i.move.to.x&&a.to.y===i.move.to.y&&(a.same=!0),h(r,a),a.piece||(a.piece=r.get(a.from.x,a.from.y).kind),a.promote||F.Piece.isPromoted(a.piece)||!F.Piece.canPromote(a.piece)||(o(a.to,r.turn)||o(a.from,r.turn))&&(a.promote=!1),l(r,a);try{r.move(a.from.x,a.from.y,a.to.x,a.to.y,a.promote)}catch(r){throw new Error(n+"手目で失敗しました: "+r)}}else r.getMovesTo(a.to.x,a.to.y,a.piece).length>0&&(a.relative="H"),r.drop(a.to.x,a.to.y,a.piece)}I(t,r);for(var n=t.length-1;n>=0;n--){var a=t[n].move;a&&(a.from?r.unmove(a.from.x,a.from.y,a.to.x,a.to.y,a.promote,a.capture):r.undrop(a.to.x,a.to.y));var i=n<=1?e:t[n-1];if(t[n].forks)for(var c=0,s=t[n].forks;c<s.length;c++){var f=s[c];u(r,f,i)}}}function i(r){return r.initial&&"HIRATE"===r.initial.preset&&r.initial.data&&(r.initial.preset="OTHER"),a(new F.Shogi(r.initial||void 0),r.moves),r}function a(r,t,e){for(var n=0;n<t.length;n++){var u=0===n?e:t[n-1],i=t[n].move;if(i)if(i.color=r.turn,i.from){i.same&&(i.to=u.move.to),h(r,i),i.promote||F.Piece.isPromoted(i.piece)||!F.Piece.canPromote(i.piece)||(o(i.to,r.turn)||o(i.from,r.turn))&&(i.promote=!1),l(r,i);try{r.move(i.from.x,i.from.y,i.to.x,i.to.y,i.promote)}catch(r){throw new Error(n+"手目で失敗しました: "+r)}}else r.getMovesTo(i.to.x,i.to.y,i.piece).length>0&&(i.relative="H"),r.drop(i.to.x,i.to.y,i.piece)}I(t,r);for(var n=t.length-1;n>=0;n--){var i=t[n].move;i&&(i.from?r.unmove(i.from.x,i.from.y,i.to.x,i.to.y,i.promote,i.capture):r.undrop(i.to.x,i.to.y));var u=0===n?e:t[n-1];if(t[n].forks)for(var c=0,s=t[n].forks;c<s.length;c++){var f=s[c];a(r,f,u)}}}function c(r){return s(new F.Shogi(r.initial||void 0),r.moves),r}function s(r,t,e){for(var o=0;o<t.length;o++){var n=0===o?e:t[o-1],u=t[o].move;if(u){u.color=r.turn,u.same&&(u.to=n.move.to);var i=r.getMovesTo(u.to.x,u.to.y,u.piece);if("H"===u.relative||0===i.length);else if(1===i.length)u.from=i[0].from;else{var a=A(u.relative,r.turn,i);if(1!==a.length)throw new Error("相対情報が不完全で複数の候補があります");u.from=a[0].from}if(u.from){h(r,u);try{r.move(u.from.x,u.from.y,u.to.x,u.to.y,u.promote)}catch(r){throw new Error(o+"手目で失敗しました: "+r)}}else r.drop(u.to.x,u.to.y,u.piece)}}I(t,r);for(var o=t.length-1;o>=0;o--){var u=t[o].move;if(u){u.from?r.unmove(u.from.x,u.from.y,u.to.x,u.to.y,u.promote,u.capture):r.undrop(u.to.x,u.to.y);var n=o<=1?e:t[o-1];if(t[o].forks)for(var c=0,f=t[o].forks;c<f.length;c++){var l=f[c];s(r,l,n)}}}}function f(r){y(r);for(var t=new F.Shogi(r.initial||void 0),e=0;e<r.moves.length;e++){C(r.moves[e].time,e>=2?r.moves[e-2].time:void 0);var n=r.moves[e].move;if(n)if(n.color=t.turn,n.from){if(e>0&&r.moves[e-1].move&&r.moves[e-1].move.to.x===n.to.x&&r.moves[e-1].move.to.y===n.to.y&&(n.same=!0),h(t,n),F.Piece.isPromoted(n.piece)){var u=t.get(n.from.x,n.from.y);u.kind!==n.piece&&(n.piece=u.kind,n.promote=!0)}else F.Piece.canPromote(n.piece)&&(o(n.to,t.turn)||o(n.from,t.turn))&&(n.promote=!1);l(t,n);try{t.move(n.from.x,n.from.y,n.to.x,n.to.y,n.promote)}catch(r){throw new Error(e+"手目で失敗しました: "+r)}}else t.getMovesTo(n.to.x,n.to.y,n.piece).length>0&&(n.relative="H"),t.drop(n.to.x,n.to.y,n.piece)}return r}function l(r,t){var e=r.getMovesTo(t.to.x,t.to.y,t.piece).map(function(t){return p(r.turn,v(t.to,t.from))});if(e.length>=2){var o=p(r.turn,v(t.to,t.from));t.relative=function(){return 1===e.filter(function(r){return r.y===o.y}).length?m(o.y):1===e.filter(function(r){return r.x===o.x}).length?g("UM"!==t.piece&&"RY"!==t.piece||0!==o.x?o.x:0===e.filter(function(r){return r.x<0}).length?-1:1):g(o.x)+m(o.y)}()}}function h(r,t){var e=r.get(t.to.x,t.to.y);e&&(t.capture=e.kind)}function p(r,t){return r===F.Color.Black?t:{x:-t.x,y:-t.y}}function d(r,t){return r===t?0:r>t?1:-1}function v(r,t){return{x:d(r.x,t.x),y:d(r.y,t.y)}}function m(r){return 0===r?"M":r>0?"D":"U"}function g(r){return 0===r?"C":r>0?"R":"L"}function A(r,t,e){for(var o=[],n=0,u=e;n<u.length;n++){var i=u[n];!function(e){r.split("").every(function(r){return k(r,t,e)})&&o.push(e)}(i)}return o}function k(r,t,e){var o=p(t,{x:e.to.x-e.from.x,y:e.to.y-e.from.y});switch(r){case"U":return o.y<0;case"M":return 0===o.y;case"D":return o.y>0;case"L":return o.x<0;case"C":return 0===o.x;case"R":return o.x>0}}function y(r){if(r.initial&&"OTHER"===r.initial.preset){for(var t=["FU","KY","KE","GI","KI","KA","HI"],e=0;e<2;e++)for(var o=0,n=t;o<n.length;o++){var u=n[o];if(0!==r.initial.data.hands[e][u])return}for(var i=[[{color:F.Color.White,kind:"KY"},{},{color:F.Color.White,kind:"FU"},{},{},{},{color:F.Color.Black,kind:"FU"},{},{color:F.Color.Black,kind:"KY"}],[{color:F.Color.White,kind:"KE"},{color:F.Color.White,kind:"KA"},{color:F.Color.White,kind:"FU"},{},{},{},{color:F.Color.Black,kind:"FU"},{color:F.Color.Black,kind:"HI"},{color:F.Color.Black,kind:"KE"}],[{color:F.Color.White,kind:"GI"},{},{color:F.Color.White,kind:"FU"},{},{},{},{color:F.Color.Black,kind:"FU"},{},{color:F.Color.Black,kind:"GI"}],[{color:F.Color.White,kind:"KI"},{},{color:F.Color.White,kind:"FU"},{},{},{},{color:F.Color.Black,kind:"FU"},{},{color:F.Color.Black,kind:"KI"}],[{color:F.Color.White,kind:"OU"},{},{color:F.Color.White,kind:"FU"},{},{},{},{color:F.Color.Black,kind:"FU"},{},{color:F.Color.Black,kind:"OU"}],[{color:F.Color.White,kind:"KI"},{},{color:F.Color.White,kind:"FU"},{},{},{},{color:F.Color.Black,kind:"FU"},{},{color:F.Color.Black,kind:"KI"}],[{color:F.Color.White,kind:"GI"},{},{color:F.Color.White,kind:"FU"},{},{},{},{color:F.Color.Black,kind:"FU"},{},{color:F.Color.Black,kind:"GI"}],[{color:F.Color.White,kind:"KE"},{color:F.Color.White,kind:"HI"},{color:F.Color.White,kind:"FU"},{},{},{},{color:F.Color.Black,kind:"FU"},{color:F.Color.Black,kind:"KA"},{color:F.Color.Black,kind:"KE"}],[{color:F.Color.White,kind:"KY"},{},{color:F.Color.White,kind:"FU"},{},{},{},{color:F.Color.Black,kind:"FU"},{},{color:F.Color.Black,kind:"KY"}]],a=[],e=0;e<9;e++)for(var c=0;c<9;c++)K(r.initial.data.board[e][c],i[e][c])||a.push(""+(e+1)+(c+1));var s={};s[""]="HIRATE",s[11]="KY",s[91]="KY_R",s[22]="KA",s[82]="HI",s[1182]="HIKY",s[2282]="2",s[228291]="3",s[11228291]="4",s[1122818291]="5",s[1121228291]="5_L",s[112122818291]="6",s[0x3fbbf1cdec333]="8",s["11212231416171818291"]="10";var f=s[a.sort().join("")];"HIRATE"===f?r.initial.data.color===F.Color.Black&&(r.initial.preset="HIRATE",delete r.initial.data):f&&r.initial.data.color===F.Color.White&&(r.initial.preset=f,delete r.initial.data)}}function K(r,t){return void 0===r.color&&void 0===t.color||void 0!==r.color&&void 0!==t.color&&r.color===t.color&&r.kind===t.kind}function I(r,t){r.length>=1&&"ILLEGAL_ACTION"===r[r.length-1].special&&(r[r.length-1].special=(t.turn?"+":"-")+"ILLEGAL_ACTION")}function C(r,t){void 0===t&&(t={now:{m:0,s:0},total:{h:0,m:0,s:0}}),r&&(r.total={h:(r.now.h||0)+t.total.h,m:r.now.m+t.total.m,s:r.now.s+t.total.s},r.total.m+=Math.floor(r.total.s/60),r.total.s=r.total.s%60,r.total.h+=Math.floor(r.total.m/60),r.total.m=r.total.m%60)}Object.defineProperty(t,"__esModule",{value:!0});/** @license
 * JSON Kifu Format
 * Copyright (c) 2014 na2hiro (https://github.com/na2hiro)
 * This software is released under the MIT License.
 * http://opensource.org/licenses/mit-license.php
 */
var F=e(0);t.canPromote=o,t.normalizeMinimal=n,t.normalizeKIF=i,t.normalizeKI2=c,t.normalizeCSA=f},function(r,t,e){"use strict";function o(r){return i.parse(r)}function n(r){return c.parse(r)}function u(r){return a.parse(r)}Object.defineProperty(t,"__esModule",{value:!0}),e(6);var i=e(7),a=e(8),c=e(9);t.parseCSA=o,t.parseKIF=n,t.parseKI2=u},function(r,t,e){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var o=e(4);t.Formats=o;var n=e(5);t.JKFPlayer=n.default;var u=e(1);t.Normalizer=u;var i=e(2);t.Parsers=i},function(r,t,e){"use strict";Object.defineProperty(t,"__esModule",{value:!0})},function(r,t,e){"use strict";/** @license
 * JSON Kifu Format
 * Copyright (c) 2014 na2hiro (https://github.com/na2hiro)
 * This software is released under the MIT License.
 * http://opensource.org/licenses/mit-license.php
 */
Object.defineProperty(t,"__esModule",{value:!0});var o=e(0),n=e(1),u=e(2),i=function(){function r(r){this.forkPointers=[],this.forks_=null,this.currentStream_=null,this.shogi=new o.Shogi(r.initial||void 0),this.initialize(r)}return r.log=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];r.debug?console.log(t):r.logs.push(t)},r.parse=function(t,e){if(e){var o=e.split(".");switch(o[o.length-1].toLowerCase()){case"jkf":return r.parseJKF(t);case"kif":case"kifu":return r.parseKIF(t);case"ki2":case"ki2u":return r.parseKI2(t);case"csa":return r.parseCSA(t)}}try{return r.parseJKF(t)}catch(t){r.log("failed to parse as jkf",t)}try{return r.parseKIF(t)}catch(t){r.log("failed to parse as kif",t)}try{return r.parseKI2(t)}catch(t){r.log("failed to parse as ki2",t)}try{return r.parseCSA(t)}catch(t){r.log("failed to parse as csa",t)}throw new Error("JKF, KIF, KI2, CSAいずれの形式でも失敗しました")},r.parseJKF=function(t){return r.log("parseJKF",t),new r(JSON.parse(t))},r.parseKIF=function(t){return r.log("parseKIF",t),new r(n.normalizeKIF(u.parseKIF(r.addLastNewLine(t))))},r.parseKI2=function(t){return r.log("parseKI2",t),new r(n.normalizeKI2(u.parseKI2(r.addLastNewLine(t))))},r.parseCSA=function(t){return r.log("parseCSA",t),new r(n.normalizeCSA(u.parseCSA(r.addLastNewLine(t))))},r.addLastNewLine=function(r){return"\n"===r.substr(r.length-1)?r:r+"\n"},r.numToZen=function(r){return"０１２３４５６７８９"[r]},r.numToKan=function(r){return"〇一二三四五六七八九"[r]},r.kindToKan=function(r){return{FU:"歩",KY:"香",KE:"桂",GI:"銀",KI:"金",KA:"角",HI:"飛",OU:"玉",TO:"と",NY:"成香",NK:"成桂",NG:"成銀",UM:"馬",RY:"龍"}[r]},r.relativeToKan=function(r){return{L:"左",C:"直",R:"右",U:"上",M:"寄",D:"引",H:"打"}[r]},r.specialToKan=function(r){return{TORYO:"投了",CHUDAN:"中断",SENNICHITE:"千日手",TIME_UP:"時間切れ",ILLEGAL_MOVE:"反則負け","+ILLEGAL_ACTION":"後手反則負け","-ILLEGAL_ACTION":"先手反則負け",JISHOGI:"持将棋",KACHI:"勝ち宣言",HIKIWAKE:"引き分け宣言",MATTA:"待った",TSUMI:"詰",FUZUMI:"不詰",ERROR:"エラー"}[r]||r},r.moveToReadableKifu=function(t){if(t.special)return r.specialToKan(t.special);var e=t.move,n=e.color===o.Color.Black?"☗":"☖";return e.same?n+="同　":n+=r.numToZen(e.to.x)+r.numToKan(e.to.y),n+=r.kindToKan(e.piece),e.relative&&(n+=e.relative.split("").map(r.relativeToKan).join("")),null!=e.promote&&(n+=e.promote?"成":"不成"),n},r.doMove=function(r,t){t&&(t.from?r.move(t.from.x,t.from.y,t.to.x,t.to.y,t.promote):r.drop(t.to.x,t.to.y,t.piece,void 0!==t.color?t.color:void 0))},r.undoMove=function(r,t){t&&(t.from?r.unmove(t.from.x,t.from.y,t.to.x,t.to.y,t.promote,t.capture):r.undrop(t.to.x,t.to.y))},r.getState=function(t){return{board:r.getBoardState(t),color:t.turn,hands:r.getHandsState(t)}},r.sameMoveMinimal=function(r,t){return r.to.x===t.to.x&&r.to.y===t.to.y&&(r.from&&t.from?r.from.x===t.from.x&&r.from.y===t.from.y&&r.promote===t.promote:r.piece===t.piece)},r.getBoardState=function(r){for(var t=[],e=1;e<=9;e++){for(var o=[],n=1;n<=9;n++){var u=r.get(e,n);o.push(u?{color:u.color,kind:u.kind}:{})}t.push(o)}return t},r.getHandsState=function(r){return[r.getHandsSummary(o.Color.Black),r.getHandsSummary(o.Color.White)]},Object.defineProperty(r.prototype,"forks",{get:function(){return null===this.forks_&&this.updateForksAndCurrentStream(),this.forks_},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"currentStream",{get:function(){return null===this.currentStream_&&this.updateForksAndCurrentStream(),this.currentStream_},enumerable:!0,configurable:!0}),r.prototype.initialize=function(r){this.kifu=r,this.tesuu=0,this.forkPointers=[]},r.prototype.forward=function(){var t=this.getMoveFormat(this.tesuu+1);if(!t)return!1;this.tesuu++;var e=t.move;return!e||(r.log("forward",this.tesuu,e),this.doMove(e),!0)},r.prototype.backward=function(){var t=this;if(this.tesuu<=0)return!1;var e=this.getMoveFormat(this.tesuu).move;return r.log("backward",this.tesuu-1,e),this.undoMove(e),this.tesuu--,this.forkPointers=this.forkPointers.filter(function(r){return r.te<=t.tesuu}),this.updateForksAndCurrentStream(),!0},r.prototype.goto=function(r){if("string"==typeof r&&(r=Number(r)),!isNaN(r)){var t=1e4;if(this.tesuu<r)for(;this.tesuu!==r&&this.forward()&&t-- >0;);else for(;this.tesuu!==r&&this.backward()&&t-- >0;);if(0===t)throw new Error("tesuu overflows")}},r.prototype.go=function(r){"string"==typeof r&&(r=Number(r)),isNaN(r)||this.goto(this.tesuu+r)},r.prototype.forkAndForward=function(r){"string"==typeof r&&(r=parseInt(r,10));var t=this.getMoveFormat(this.tesuu+1).forks;return!(!t||t.length<=r)&&(this.forkPointers.push({te:this.tesuu+1,forkIndex:r}),this.updateForksAndCurrentStream(),this.forward())},r.prototype.inputMove=function(t){if(this.getMoveFormat().special)throw new Error("終了局面へ棋譜を追加することは出来ません");if(null!=t.from&&null==t.promote){var e=this.shogi.get(t.from.x,t.from.y);if(!o.Piece.isPromoted(e.kind)&&o.Piece.canPromote(e.kind)&&(n.canPromote(t.from,e.color)||n.canPromote(t.to,e.color)))return!1}var u=this.getMoveFormat(this.tesuu+1);if(u){if(u.move&&r.sameMoveMinimal(u.move,t))return this.forward(),!0;if(u.forks)for(var i=0;i<u.forks.length;i++){var a=u.forks[i][0];if(a&&a.move&&r.sameMoveMinimal(a.move,t))return this.forkAndForward(i),!0}}this.doMove(t);var c,s={move:t},f=this.tesuu<this.getMaxTesuu();return f?(c=this.getMoveFormat(this.tesuu+1),c.forks||(c.forks=[]),c.forks.push([s])):this.forks[this.forks.length-1].moves.push(s),this.updateForksAndCurrentStream(),n.normalizeMinimal(this.kifu),this.undoMove(t),f?this.forkAndForward(c.forks.length-1):this.forward(),!0},r.prototype.getBoard=function(r,t){return this.shogi.get(r,t)},r.prototype.getComments=function(r){return void 0===r&&(r=this.tesuu),this.getMoveFormat(r).comments||[]},r.prototype.getMove=function(r){return void 0===r&&(r=this.tesuu),this.getMoveFormat(r).move},r.prototype.getReadableKifu=function(t){return void 0===t&&(t=this.tesuu),0===t?"開始局面":r.moveToReadableKifu(this.getMoveFormat(t))},r.prototype.getReadableForkKifu=function(t){return void 0===t&&(t=this.tesuu),this.getNextFork(t).map(function(t){return r.moveToReadableKifu(t[0])})},r.prototype.getMaxTesuu=function(){return this.currentStream.length-1},r.prototype.toJKF=function(){return JSON.stringify(this.kifu)},r.prototype.getState=function(){return r.getState(this.shogi)},r.prototype.getReadableKifuState=function(){for(var r=[],t=0;t<=this.getMaxTesuu();t++)r.push({comments:this.getComments(t),forks:this.getReadableForkKifu(t-1),kifu:this.getReadableKifu(t)});return r},r.prototype.updateForksAndCurrentStream=function(){for(var r=[],t=[],e=this.kifu.moves,o=0,n=0,u=this.forkPointers;n<u.length;n++){var i=u[n];r.push({te:o,moves:e}),t=t.concat(e.slice(0,i.te-o)),e=e[i.te-o].forks[i.forkIndex],o=i.te}r.push({te:o,moves:e}),this.forks_=r,this.currentStream_=t.concat(e.slice())},r.prototype.getMoveFormat=function(r){return void 0===r&&(r=this.tesuu),this.currentStream[r]},r.prototype.getNextFork=function(r){void 0===r&&(r=this.tesuu);var t=this.getMoveFormat(r+1);return t&&t.forks?t.forks:[]},r.prototype.doMove=function(t){r.doMove(this.shogi,t)},r.prototype.undoMove=function(t){r.undoMove(this.shogi,t)},r.debug=!1,r.logs=[],r}();t.default=i},function(r,t){},function(r,t,e){"use strict";function o(r,t,e,n){this.message=r,this.expected=t,this.found=e,this.location=n,this.name="SyntaxError","function"==typeof Error.captureStackTrace&&Error.captureStackTrace(this,o)}function n(r,t){function e(r,t){return{type:"literal",text:r,ignoreCase:t}}function n(r,t,e){return{type:"class",parts:r,inverted:t,ignoreCase:e}}function u(t){var e,o=gt[t];if(o)return o;for(e=t-1;!gt[e];)e--;for(o=gt[e],o={line:o.line,column:o.column};e<t;)10===r.charCodeAt(e)?(o.line++,o.column=1):o.column++,e++;return gt[t]=o,o}function i(r,t){var e=u(r),o=u(t);return{start:{offset:r,line:e.line,column:e.column},end:{offset:t,line:o.line,column:o.column}}}function a(r){vt<At||(vt>At&&(At=vt,kt=[]),kt.push(r))}function c(){var r;return r=s(),r===P&&(r=d()),r}function s(){var r,t,e,o,n;return r=vt,t=f(),t!==P?(e=l(),e===P&&(e=null),e!==P?(o=m(),o!==P?(n=C(),n===P&&(n=null),n!==P?(mt=r,t=j(e,o,n),r=t):(vt=r,r=P)):(vt=r,r=P)):(vt=r,r=P)):(vt=r,r=P),r}function f(){var t,e,o,n,u;for(t=vt,e=[],o=w();o!==P;)e.push(o),o=w();return e!==P?(r.substr(vt,2)===W?(o=W,vt+=2):(o=P,0===yt&&a(D)),o!==P?(r.substr(vt,2)===z?(n=z,vt+=2):(n=P,0===yt&&a(J)),n===P&&(r.substr(vt,2)===V?(n=V,vt+=2):(n=P,0===yt&&a(Z))),n===P&&(n=null),n!==P?(u=H(),u!==P?(e=[e,o,n,u],t=e):(vt=t,t=P)):(vt=t,t=P)):(vt=t,t=P)):(vt=t,t=P),t}function l(){var r,t,e;return r=vt,t=v(),t===P&&(t=null),t!==P?(e=h(),e!==P?(mt=r,t=$(t,e),r=t):(vt=r,r=P)):(vt=r,r=P),r}function h(){var r,t,e;for(r=vt,t=[],e=p();e!==P;)t.push(e),e=p();return t!==P&&(mt=r,t=q(t)),r=t}function p(){var t,e,o,n,u,i,c;for(t=vt,e=[],o=w();o!==P;)e.push(o),o=w();if(e!==P)if(36===r.charCodeAt(vt)?(o=Q,vt++):(o=P,0===yt&&a(X)),o!==P){if(n=[],rr.test(r.charAt(vt))?(u=r.charAt(vt),vt++):(u=P,0===yt&&a(tr)),u!==P)for(;u!==P;)n.push(u),rr.test(r.charAt(vt))?(u=r.charAt(vt),vt++):(u=P,0===yt&&a(tr));else n=P;if(n!==P)if(58===r.charCodeAt(vt)?(u=er,vt++):(u=P,0===yt&&a(or)),u!==P){for(i=[],c=N();c!==P;)i.push(c),c=N();i!==P?(c=H(),c!==P?(mt=t,e=nr(n,i),t=e):(vt=t,t=P)):(vt=t,t=P)}else vt=t,t=P;else vt=t,t=P}else vt=t,t=P;else vt=t,t=P;return t}function d(){var r,t,e,o;return r=vt,t=v(),t===P&&(t=null),t!==P?(e=m(),e===P&&(e=null),e!==P?(o=C(),o!==P?(mt=r,t=ur(t,e,o),r=t):(vt=r,r=P)):(vt=r,r=P)):(vt=r,r=P),r}function v(){var t,e,o,n,u,i,c,s;for(t=vt,e=[],o=w();o!==P;)e.push(o),o=w();if(e!==P){if(o=vt,r.substr(vt,2)===ir?(n=ir,vt+=2):(n=P,0===yt&&a(ar)),n!==P){for(u=[],i=N();i!==P;)u.push(i),i=N();u!==P?(i=H(),i!==P?(mt=o,n=cr(u),o=n):(vt=o,o=P)):(vt=o,o=P)}else vt=o,o=P;if(o===P&&(o=null),o!==P){for(n=[],u=w();u!==P;)n.push(u),u=w();if(n!==P){if(u=vt,r.substr(vt,2)===sr?(i=sr,vt+=2):(i=P,0===yt&&a(fr)),i!==P){for(c=[],s=N();s!==P;)c.push(s),s=N();c!==P?(s=H(),s!==P?(mt=u,i=lr(o,c),u=i):(vt=u,u=P)):(vt=u,u=P)}else vt=u,u=P;u===P&&(u=null),u!==P?(mt=t,e=hr(o,u),t=e):(vt=t,t=P)}else vt=t,t=P}else vt=t,t=P}else vt=t,t=P;return t}function m(){var r,t,e,o,n,u,i;for(r=vt,t=[],e=w();e!==P;)t.push(e),e=w();if(t!==P)if(e=g(),e===P&&(e=A())===P&&(e=vt,o=pr,o!==P&&(mt=e,o=dr()),e=o),e!==P)if((o=K())!==P){for(n=[],u=w();u!==P;)n.push(u),u=w();n!==P?(u=b(),u!==P?(i=H(),i!==P?(mt=r,t=vr(e,o,u),r=t):(vt=r,r=P)):(vt=r,r=P)):(vt=r,r=P)}else vt=r,r=P;else vt=r,r=P;else vt=r,r=P;return r}function g(){var t,e,o,n;if(t=vt,r.substr(vt,2)===mr?(e=mr,vt+=2):(e=P,0===yt&&a(gr)),e!==P){for(o=[],n=S();n!==P;)o.push(n),n=S();o!==P?(n=H(),n!==P?(mt=t,e=Ar(o),t=e):(vt=t,t=P)):(vt=t,t=P)}else vt=t,t=P;return t}function A(){var r,t,e;if(r=vt,t=[],(e=k())!==P)for(;e!==P;)t.push(e),e=k();else t=P;return t!==P&&(mt=r,t=kr(t)),r=t}function k(){var t,e,o,n,u;if(t=vt,80===r.charCodeAt(vt)?(e=yr,vt++):(e=P,0===yt&&a(Kr)),e!==P)if(Ir.test(r.charAt(vt))?(o=r.charAt(vt),vt++):(o=P,0===yt&&a(Cr)),o!==P){if(n=[],(u=y())!==P)for(;u!==P;)n.push(u),u=y();else n=P;n!==P?(u=H(),u!==P?(mt=t,e=Fr(n),t=e):(vt=t,t=P)):(vt=t,t=P)}else vt=t,t=P;else vt=t,t=P;return t}function y(){var t,e,o;return t=vt,e=b(),e!==P?(o=O(),o!==P?(mt=t,e=xr(e,o),t=e):(vt=t,t=P)):(vt=t,t=P),t===P&&(t=vt,r.substr(vt,3)===Er?(e=Er,vt+=3):(e=P,0===yt&&a(Ur)),e!==P&&(mt=t,e=br()),t=e),t}function K(){var r,t,e;for(r=vt,t=[],e=I();e!==P;)t.push(e),e=I();return t!==P&&(mt=r,t=wr(t)),r=t}function I(){var t,e,o,n,u;if(t=vt,80===r.charCodeAt(vt)?(e=yr,vt++):(e=P,0===yt&&a(Kr)),e!==P)if((o=b())!==P){if(n=[],(u=S())!==P)for(;u!==P;)n.push(u),u=S();else n=P;n!==P?(u=H(),u!==P?(mt=t,e=Mr(o,n),t=e):(vt=t,t=P)):(vt=t,t=P)}else vt=t,t=P;else vt=t,t=P;return t}function C(){var r,t,e,o,n;if(r=vt,(t=F())!==P){for(e=[],o=x();o!==P;)e.push(o),o=x();if(e!==P){for(o=[],n=w();n!==P;)o.push(n),n=w();o!==P?(mt=r,t=Tr(t,e),r=t):(vt=r,r=P)}else vt=r,r=P}else vt=r,r=P;return r}function F(){var r,t,e;for(r=vt,t=[],e=w();e!==P;)t.push(e),e=w();return t!==P&&(mt=r,t=Or(t)),r=t}function x(){var r,t,e,o,n;if(r=vt,t=E(),t===P&&(t=U()),t!==P)if(e=M(),e===P&&(e=null),e!==P){for(o=[],n=w();n!==P;)o.push(n),n=w();o!==P?(mt=r,t=Sr(t,e,o),r=t):(vt=r,r=P)}else vt=r,r=P;else vt=r,r=P;return r}function E(){var r,t,e,o,n,u;return r=vt,t=b(),t!==P?(e=T(),e!==P?(o=T(),o!==P?(n=O(),n!==P?(u=H(),u!==P?(mt=r,t=Hr(e,o,n),r=t):(vt=r,r=P)):(vt=r,r=P)):(vt=r,r=P)):(vt=r,r=P)):(vt=r,r=P),r}function U(){var t,e,o,n;if(t=vt,37===r.charCodeAt(vt)?(e=Nr,vt++):(e=P,0===yt&&a(Rr)),e!==P){if(o=[],Gr.test(r.charAt(vt))?(n=r.charAt(vt),vt++):(n=P,0===yt&&a(Yr)),n!==P)for(;n!==P;)o.push(n),Gr.test(r.charAt(vt))?(n=r.charAt(vt),vt++):(n=P,0===yt&&a(Yr));else o=P;o!==P?(n=H(),n!==P?(mt=t,e=Br(o),t=e):(vt=t,t=P)):(vt=t,t=P)}else vt=t,t=P;return t}function b(){var t,e;return t=vt,43===r.charCodeAt(vt)?(e=Pr,vt++):(e=P,0===yt&&a(_r)),e!==P&&(mt=t,e=Lr()),t=e,t===P&&(t=vt,45===r.charCodeAt(vt)?(e=jr,vt++):(e=P,0===yt&&a(Wr)),e!==P&&(mt=t,e=Dr()),t=e),t}function w(){var t,e,o,n;if(t=vt,39===r.charCodeAt(vt)?(e=zr,vt++):(e=P,0===yt&&a(Jr)),e!==P){for(o=[],n=N();n!==P;)o.push(n),n=N();o!==P?(n=H(),n!==P?(mt=t,e=Vr(o),t=e):(vt=t,t=P)):(vt=t,t=P)}else vt=t,t=P;return t}function M(){var t,e,o,n;if(t=vt,84===r.charCodeAt(vt)?(e=Zr,vt++):(e=P,0===yt&&a($r)),e!==P){for(o=[],qr.test(r.charAt(vt))?(n=r.charAt(vt),vt++):(n=P,0===yt&&a(Qr));n!==P;)o.push(n),qr.test(r.charAt(vt))?(n=r.charAt(vt),vt++):(n=P,0===yt&&a(Qr));o!==P?(n=H(),n!==P?(mt=t,e=Xr(o),t=e):(vt=t,t=P)):(vt=t,t=P)}else vt=t,t=P;return t}function T(){var t,e,o;return t=vt,qr.test(r.charAt(vt))?(e=r.charAt(vt),vt++):(e=P,0===yt&&a(Qr)),e!==P?(qr.test(r.charAt(vt))?(o=r.charAt(vt),vt++):(o=P,0===yt&&a(Qr)),o!==P?(mt=t,e=rt(e,o),t=e):(vt=t,t=P)):(vt=t,t=P),t}function O(){var t,e,o;return t=vt,tt.test(r.charAt(vt))?(e=r.charAt(vt),vt++):(e=P,0===yt&&a(et)),e!==P?(tt.test(r.charAt(vt))?(o=r.charAt(vt),vt++):(o=P,0===yt&&a(et)),o!==P?(mt=t,e=ot(e,o),t=e):(vt=t,t=P)):(vt=t,t=P),t}function S(){var r,t,e;return r=vt,t=T(),t!==P?(e=O(),e!==P?(mt=r,t=nt(t,e),r=t):(vt=r,r=P)):(vt=r,r=P),r}function H(){var t,e,o;if(t=vt,13===r.charCodeAt(vt)?(e=ut,vt++):(e=P,0===yt&&a(it)),e===P&&(e=null),e!==P?(10===r.charCodeAt(vt)?(o=at,vt++):(o=P,0===yt&&a(ct)),o!==P?(e=[e,o],t=e):(vt=t,t=P)):(vt=t,t=P),t===P){for(t=vt,e=[],32===r.charCodeAt(vt)?(o=st,vt++):(o=P,0===yt&&a(ft));o!==P;)e.push(o),32===r.charCodeAt(vt)?(o=st,vt++):(o=P,0===yt&&a(ft));e!==P?(44===r.charCodeAt(vt)?(o=lt,vt++):(o=P,0===yt&&a(ht)),o!==P?(e=[e,o],t=e):(vt=t,t=P)):(vt=t,t=P)}return t}function N(){var t;return pt.test(r.charAt(vt))?(t=r.charAt(vt),vt++):(t=P,0===yt&&a(dt)),t}function R(r){var t,e=r%60;return t=(r-e)/60,{m:t,s:e}}function G(){return[[{color:1,kind:"KY"},{},{color:1,kind:"FU"},{},{},{},{color:0,kind:"FU"},{},{color:0,kind:"KY"}],[{color:1,kind:"KE"},{color:1,kind:"KA"},{color:1,kind:"FU"},{},{},{},{color:0,kind:"FU"},{color:0,kind:"HI"},{color:0,kind:"KE"}],[{color:1,kind:"GI"},{},{color:1,kind:"FU"},{},{},{},{color:0,kind:"FU"},{},{color:0,kind:"GI"}],[{color:1,kind:"KI"},{},{color:1,kind:"FU"},{},{},{},{color:0,kind:"FU"},{},{color:0,kind:"KI"}],[{color:1,kind:"OU"},{},{color:1,kind:"FU"},{},{},{},{color:0,kind:"FU"},{},{color:0,kind:"OU"}],[{color:1,kind:"KI"},{},{color:1,kind:"FU"},{},{},{},{color:0,kind:"FU"},{},{color:0,kind:"KI"}],[{color:1,kind:"GI"},{},{color:1,kind:"FU"},{},{},{},{color:0,kind:"FU"},{},{color:0,kind:"GI"}],[{color:1,kind:"KE"},{color:1,kind:"HI"},{color:1,kind:"FU"},{},{},{},{color:0,kind:"FU"},{color:0,kind:"KA"},{color:0,kind:"KE"}],[{color:1,kind:"KY"},{},{color:1,kind:"FU"},{},{},{},{color:0,kind:"FU"},{},{color:0,kind:"KY"}]]}function Y(r){return{EVENT:"棋戦",SITE:"場所",START_TIME:"開始日時",END_TIME:"終了日時",TIME_LIMIT:"持ち時間"}[r]||r}t=void 0!==t?t:{};var B,P={},_={kifu:c},L=c,j=function(r,t,e){var o={header:r.header,initial:t,moves:e};return r&&r.players&&(r.players[0]&&(o.header["先手"]=r.players[0]),r.players[1]&&(o.header["後手"]=r.players[1])),o},W="V2",D=e("V2",!1),z=".1",J=e(".1",!1),V=".2",Z=e(".2",!1),$=function(r,t){return{players:r,header:t}},q=function(r){for(var t={},e=0;e<r.length;e++)t[Y(r[e].k)]=r[e].v;return t},Q="$",X=e("$",!1),rr=/^[^:]/,tr=n([":"],!0,!1),er=":",or=e(":",!1),nr=function(r,t){return{k:r.join(""),v:t.join("")}},ur=function(r,t,e){var o={header:{},initial:t,moves:e};return r&&(r[0]&&(o.header["先手"]=r[0]),r[1]&&(o.header["後手"]=r[1])),o},ir="N+",ar=e("N+",!1),cr=function(r){return r},sr="N-",fr=e("N-",!1),lr=function(r,t){return t},hr=function(r,t){return[r?r.join(""):null,t?t.join(""):null]},pr="",dr=function(){return"NO"},vr=function(r,t,e){return"NO"==r?r=t:r.data.hands=t.data.hands,r.data.color=e,r},mr="PI",gr=e("PI",!1),Ar=function(r){for(var t={preset:"OTHER",data:{board:G()}},e=0;e<r.length;e++)t.data.board[r[e].xy.x-1][r[e].xy.y-1]={};return t},kr=function(r){for(var t=[],e=0;e<9;e++){for(var o=[],n=0;n<9;n++)o.push(r[n][8-e]);t.push(o)}return{preset:"OTHER",data:{board:t}}},yr="P",Kr=e("P",!1),Ir=/^[1-9]/,Cr=n([["1","9"]],!1,!1),Fr=function(r){return r},xr=function(r,t){return{color:r,kind:t}},Er=" * ",Ur=e(" * ",!1),br=function(){return{}},wr=function(r){for(var t=[],e=[{FU:0,KY:0,KE:0,GI:0,KI:0,KA:0,HI:0},{FU:0,KY:0,KE:0,GI:0,KI:0,KA:0,HI:0}],o={FU:18,KY:4,KE:4,GI:4,KI:4,KA:2,HI:2},n=0;n<9;n++){for(var u=[],i=0;i<9;i++)u.push({});t.push(u)}r:for(var n=0;n<r.length;n++)for(var i=0;i<r[n].pieces.length;i++){var a=r[n].pieces[i];if(0==a.xy.x){if("AL"==a.piece){e[r[n].teban]=o;break r}var c=e[r[n].teban];c[a.piece]++}else t[a.xy.x-1][a.xy.y-1]={color:r[n].teban,kind:a.piece};"OU"!=a.piece&&o[a.piece]--}return{preset:"OTHER",data:{board:t,hands:e}}},Mr=function(r,t){return{teban:r,pieces:t}},Tr=function(r,t){return t.unshift(r),t},Or=function(r){return r.length>0?{comments:r}:{}},Sr=function(r,t,e){var o={};return e.length>0&&(o.comments=e),t&&(o.time=t),r.special?o.special=r.special:o.move=r,o},Hr=function(r,t,e){var o={to:t,piece:e};return 0!=r.x&&(o.from=r),o},Nr="%",Rr=e("%",!1),Gr=/^[\-+_A-Z]/,Yr=n(["-","+","_",["A","Z"]],!1,!1),Br=function(r){return{special:r.join("")}},Pr="+",_r=e("+",!1),Lr=function(){return 0},jr="-",Wr=e("-",!1),Dr=function(){return 1},zr="'",Jr=e("'",!1),Vr=function(r){return r.join("")},Zr="T",$r=e("T",!1),qr=/^[0-9]/,Qr=n([["0","9"]],!1,!1),Xr=function(r){return{now:R(parseInt(r.join("")))}},rt=function(r,t){return{x:parseInt(r),y:parseInt(t)}},tt=/^[A-Z]/,et=n([["A","Z"]],!1,!1),ot=function(r,t){return r+t},nt=function(r,t){return{xy:r,piece:t}},ut="\r",it=e("\r",!1),at="\n",ct=e("\n",!1),st=" ",ft=e(" ",!1),lt=",",ht=e(",",!1),pt=/^[^\r\n]/,dt=n(["\r","\n"],!0,!1),vt=0,mt=0,gt=[{line:1,column:1}],At=0,kt=[],yt=0;if("startRule"in t){if(!(t.startRule in _))throw new Error("Can't start parsing from rule \""+t.startRule+'".');L=_[t.startRule]}if((B=L())!==P&&vt===r.length)return B;throw B!==P&&vt<r.length&&a(function(){return{type:"end"}}()),function(r,t,e){return new o(o.buildMessage(r,t),r,t,e)}(kt,At<r.length?r.charAt(At):null,At<r.length?i(At,At+1):i(At,At))}!function(r,t){function e(){this.constructor=r}e.prototype=t.prototype,r.prototype=new e}(o,Error),o.buildMessage=function(r,t){function e(r){return r.charCodeAt(0).toString(16).toUpperCase()}function o(r){return r.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(r){return"\\x0"+e(r)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(r){return"\\x"+e(r)})}function n(r){return r.replace(/\\/g,"\\\\").replace(/\]/g,"\\]").replace(/\^/g,"\\^").replace(/-/g,"\\-").replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(r){return"\\x0"+e(r)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(r){return"\\x"+e(r)})}function u(r){return i[r.type](r)}var i={literal:function(r){return'"'+o(r.text)+'"'},class:function(r){var t,e="";for(t=0;t<r.parts.length;t++)e+=r.parts[t]instanceof Array?n(r.parts[t][0])+"-"+n(r.parts[t][1]):n(r.parts[t]);return"["+(r.inverted?"^":"")+e+"]"},any:function(r){return"any character"},end:function(r){return"end of input"},other:function(r){return r.description}};return"Expected "+function(r){var t,e,o=new Array(r.length);for(t=0;t<r.length;t++)o[t]=u(r[t]);if(o.sort(),o.length>0){for(t=1,e=1;t<o.length;t++)o[t-1]!==o[t]&&(o[e]=o[t],e++);o.length=e}switch(o.length){case 1:return o[0];case 2:return o[0]+" or "+o[1];default:return o.slice(0,-1).join(", ")+", or "+o[o.length-1]}}(r)+" but "+function(r){return r?'"'+o(r)+'"':"end of input"}(t)+" found."},r.exports={SyntaxError:o,parse:n}},function(r,t,e){"use strict";function o(r,t,e,n){this.message=r,this.expected=t,this.found=e,this.location=n,this.name="SyntaxError","function"==typeof Error.captureStackTrace&&Error.captureStackTrace(this,o)}function n(r,t){function e(r,t){return{type:"literal",text:r,ignoreCase:t}}function n(r,t,e){return{type:"class",parts:r,inverted:t,ignoreCase:e}}function u(t){var e,o=le[t];if(o)return o;for(e=t-1;!le[e];)e--;for(o=le[e],o={line:o.line,column:o.column};e<t;)10===r.charCodeAt(e)?(o.line++,o.column=1):o.column++,e++;return le[t]=o,o}function i(r,t){var e=u(r),o=u(t);return{start:{offset:r,line:e.line,column:e.column},end:{offset:t,line:o.line,column:o.column}}}function a(r){se<he||(se>he&&(he=se,pe=[]),pe.push(r))}function c(){var r,t,e,o,n,u,i;for(r=se,t=[],e=s();e!==W;)t.push(e),e=s();if(t!==W)if(e=f(),e===W&&(e=null),e!==W){for(o=[],n=s();n!==W;)o.push(n),n=s();if(o!==W)if((n=d())!==W){for(u=[],i=b();i!==W;)u.push(i),i=b();u!==W?(fe=r,t=J(t,e,o,n,u),r=t):(se=r,r=W)}else se=r,r=W;else se=r,r=W}else se=r,r=W;else se=r,r=W;return r}function s(){var t,e,o,n,u,i;if(t=se,e=[],V.test(r.charAt(se))?(o=r.charAt(se),se++):(o=W,0===de&&a(Z)),o!==W)for(;o!==W;)e.push(o),V.test(r.charAt(se))?(o=r.charAt(se),se++):(o=W,0===de&&a(Z));else e=W;if(e!==W)if(65306===r.charCodeAt(se)?(o=$,se++):(o=W,0===de&&a(q)),o!==W){for(n=[],u=H();u!==W;)n.push(u),u=H();if(n!==W){if(u=[],(i=M())!==W)for(;i!==W;)u.push(i),i=M();else u=W;u!==W?(fe=t,e=Q(e,n),t=e):(se=t,t=W)}else se=t,t=W}else se=t,t=W;else se=t,t=W;return t===W&&(t=se,X.test(r.charAt(se))?(e=r.charAt(se),se++):(e=W,0===de&&a(rr)),e!==W?(r.substr(se,2)===tr?(o=tr,se+=2):(o=W,0===de&&a(er)),o!==W?(n=M(),n!==W?(fe=t,e=or(e),t=e):(se=t,t=W)):(se=t,t=W)):(se=t,t=W)),t}function f(){var t,e,o,n,u,i,c,s;if(t=se,e=se,32===r.charCodeAt(se)?(o=nr,se++):(o=W,0===de&&a(ur)),o!==W){for(n=[],u=H();u!==W;)n.push(u),u=H();n!==W?(u=M(),u!==W?(o=[o,n,u],e=o):(se=e,e=W)):(se=e,e=W)}else se=e,e=W;if(e===W&&(e=null),e!==W){if(o=se,43===r.charCodeAt(se)?(n=ir,se++):(n=W,0===de&&a(ar)),n!==W){for(u=[],i=H();i!==W;)u.push(i),i=H();u!==W?(i=M(),i!==W?(n=[n,u,i],o=n):(se=o,o=W)):(se=o,o=W)}else se=o,o=W;if(o===W&&(o=null),o!==W){if(n=[],(u=l())!==W)for(;u!==W;)n.push(u),u=l();else n=W;if(n!==W){if(u=se,43===r.charCodeAt(se)?(i=ir,se++):(i=W,0===de&&a(ar)),i!==W){for(c=[],s=H();s!==W;)c.push(s),s=H();c!==W?(s=M(),s!==W?(i=[i,c,s],u=i):(se=u,u=W)):(se=u,u=W)}else se=u,u=W;u===W&&(u=null),u!==W?(fe=t,e=cr(n),t=e):(se=t,t=W)}else se=t,t=W}else se=t,t=W}else se=t,t=W;return t}function l(){var t,e,o,n,u,i;if(t=se,124===r.charCodeAt(se)?(e=sr,se++):(e=W,0===de&&a(fr)),e!==W){if(o=[],(n=h())!==W)for(;n!==W;)o.push(n),n=h();else o=W;if(o!==W)if(124===r.charCodeAt(se)?(n=sr,se++):(n=W,0===de&&a(fr)),n!==W){if(u=[],(i=H())!==W)for(;i!==W;)u.push(i),i=H();else u=W;u!==W?(i=M(),i!==W?(fe=t,e=lr(o),t=e):(se=t,t=W)):(se=t,t=W)}else se=t,t=W;else se=t,t=W}else se=t,t=W;return t}function h(){var t,e,o;return t=se,e=p(),e!==W?(o=K(),o!==W?(fe=t,e=hr(e,o),t=e):(se=t,t=W)):(se=t,t=W),t===W&&(t=se,r.substr(se,2)===pr?(e=pr,se+=2):(e=W,0===de&&a(dr)),e!==W&&(fe=t,e=vr()),t=e),t}function p(){var t,e;return t=se,32===r.charCodeAt(se)?(e=nr,se++):(e=W,0===de&&a(ur)),e===W&&(43===r.charCodeAt(se)?(e=ir,se++):(e=W,0===de&&a(ar)),e===W&&(94===r.charCodeAt(se)?(e=mr,se++):(e=W,0===de&&a(gr)))),e!==W&&(fe=t,e=Ar()),t=e,t===W&&(t=se,118===r.charCodeAt(se)?(e=kr,se++):(e=W,0===de&&a(yr)),e===W&&(86===r.charCodeAt(se)?(e=Kr,se++):(e=W,0===de&&a(Ir))),e!==W&&(fe=t,e=Cr()),t=e),t}function d(){var r,t,e,o;if(r=se,(t=v())!==W){for(e=[],o=m();o!==W;)e.push(o),o=m();e!==W?(o=U(),o===W&&(o=null),o!==W?(fe=r,t=Fr(t,e,o),r=t):(se=r,r=W)):(se=r,r=W)}else se=r,r=W;return r}function v(){var r,t,e;for(r=se,t=[],e=E();e!==W;)t.push(e),e=E();return t!==W?(e=g(),e===W&&(e=null),e!==W?(fe=r,t=xr(t),r=t):(se=r,r=W)):(se=r,r=W),r}function m(){var t,e,o,n,u,i;if(t=se,(e=A())!==W){for(o=[],n=E();n!==W;)o.push(n),n=E();if(o!==W)if(n=g(),n===W&&(n=null),n!==W){for(u=[],(i=M())===W&&(32===r.charCodeAt(se)?(i=nr,se++):(i=W,0===de&&a(ur)));i!==W;)u.push(i),(i=M())===W&&(32===r.charCodeAt(se)?(i=nr,se++):(i=W,0===de&&a(ur)));u!==W?(fe=t,e=Er(e,o),t=e):(se=t,t=W)}else se=t,t=W;else se=t,t=W}else se=t,t=W;return t}function g(){var t,e,o,n;if(t=se,38===r.charCodeAt(se)?(e=Ur,se++):(e=W,0===de&&a(br)),e!==W){for(o=[],n=H();n!==W;)o.push(n),n=H();o!==W?(n=M(),n!==W?(e=[e,o,n],t=e):(se=t,t=W)):(se=t,t=W)}else se=t,t=W;return t}function A(){var t,e,o,n,u;if(t=se,wr.test(r.charAt(se))?(e=r.charAt(se),se++):(e=W,0===de&&a(Mr)),e!==W)if((o=k())!==W){for(n=[],(u=M())===W&&(32===r.charCodeAt(se)?(u=nr,se++):(u=W,0===de&&a(ur)));u!==W;)n.push(u),(u=M())===W&&(32===r.charCodeAt(se)?(u=nr,se++):(u=W,0===de&&a(ur)));n!==W?(fe=t,e=Tr(o),t=e):(se=t,t=W)}else se=t,t=W;else se=t,t=W;return t}function k(){var t,e,o,n,u,i,c;return t=se,e=y(),e!==W?(o=K(),o!==W?(n=I(),n===W&&(n=null),n!==W?(u=C(),u===W&&(u=null),u!==W?(25104===r.charCodeAt(se)?(i=Or,se++):(i=W,0===de&&a(Sr)),i===W&&(r.substr(se,2)===Hr?(i=Hr,se+=2):(i=W,0===de&&a(Nr))),i===W&&(i=null),i!==W?(25171===r.charCodeAt(se)?(c=Rr,se++):(c=W,0===de&&a(Gr)),c===W&&(c=null),c!==W?(fe=t,e=Yr(e,o,n,u,i,c),t=e):(se=t,t=W)):(se=t,t=W)):(se=t,t=W)):(se=t,t=W)):(se=t,t=W)):(se=t,t=W),t}function y(){var t,e,o;return t=se,e=F(),e!==W?(o=x(),o!==W?(fe=t,e=Br(e,o),t=e):(se=t,t=W)):(se=t,t=W),t===W&&(t=se,21516===r.charCodeAt(se)?(e=Pr,se++):(e=W,0===de&&a(_r)),e!==W?(12288===r.charCodeAt(se)?(o=Lr,se++):(o=W,0===de&&a(jr)),o===W&&(o=null),o!==W?(fe=t,e=Wr(),t=e):(se=t,t=W)):(se=t,t=W)),t}function K(){var t,e,o;return t=se,25104===r.charCodeAt(se)?(e=Or,se++):(e=W,0===de&&a(Sr)),e===W&&(e=null),e!==W?(Dr.test(r.charAt(se))?(o=r.charAt(se),se++):(o=W,0===de&&a(zr)),o!==W?(fe=t,e=Jr(e,o),t=e):(se=t,t=W)):(se=t,t=W),t}function I(){var t;return Vr.test(r.charAt(se))?(t=r.charAt(se),se++):(t=W,0===de&&a(Zr)),t}function C(){var t;return $r.test(r.charAt(se))?(t=r.charAt(se),se++):(t=W,0===de&&a(qr)),t}function F(){var t,e;return t=se,Qr.test(r.charAt(se))?(e=r.charAt(se),se++):(e=W,0===de&&a(Xr)),e!==W&&(fe=t,e=rt(e)),t=e}function x(){var t,e;return t=se,tt.test(r.charAt(se))?(e=r.charAt(se),se++):(e=W,0===de&&a(et)),e!==W&&(fe=t,e=ot(e)),t=e}function E(){var t,e,o,n;if(t=se,42===r.charCodeAt(se)?(e=nt,se++):(e=W,0===de&&a(ut)),e!==W){for(o=[],n=H();n!==W;)o.push(n),n=H();o!==W?(n=M(),n!==W?(fe=t,e=it(o),t=e):(se=t,t=W)):(se=t,t=W)}else se=t,t=W;return t}function U(){var t,e,o,n,u,i,c,s,f,l,h,p;if(t=se,r.substr(se,2)===at?(e=at,se+=2):(e=W,0===de&&a(ct)),e!==W){if(o=[],st.test(r.charAt(se))?(n=r.charAt(se),se++):(n=W,0===de&&a(ft)),n!==W)for(;n!==W;)o.push(n),st.test(r.charAt(se))?(n=r.charAt(se),se++):(n=W,0===de&&a(ft));else o=W;o!==W?(25163===r.charCodeAt(se)?(n=lt,se++):(n=W,0===de&&a(ht)),n!==W?(u=se,12391===r.charCodeAt(se)?(i=pt,se++):(i=W,0===de&&a(dt)),i!==W?(c=w(),c!==W?(r.substr(se,2)===vt?(s=vt,se+=2):(s=W,0===de&&a(mt)),s!==W?(f=se,r.substr(se,2)===gt?(l=gt,se+=2):(l=W,0===de&&a(At)),l!==W&&(fe=f,l=kt(c)),f=l,f===W&&(f=se,r.substr(se,2)===yt?(l=yt,se+=2):(l=W,0===de&&a(Kt)),l!==W?(h=se,r.substr(se,2)===gt?(p=gt,se+=2):(p=W,0===de&&a(At)),p!==W&&(fe=h,p=It(c)),h=p,h===W&&(h=se,r.substr(se,2)===Ct?(p=Ct,se+=2):(p=W,0===de&&a(Ft)),p!==W&&(fe=h,p=xt(c)),h=p),h!==W?(fe=f,l=Et(c,h),f=l):(se=f,f=W)):(se=f,f=W)),f!==W?(fe=u,i=Et(c,f),u=i):(se=u,u=W)):(se=u,u=W)):(se=u,u=W)):(se=u,u=W),u===W&&(u=se,r.substr(se,8)===Ut?(i=Ut,se+=8):(i=W,0===de&&a(bt)),i!==W?(c=w(),c!==W?(r.substr(se,4)===wt?(s=wt,se+=4):(s=W,0===de&&a(Mt)),s!==W?(fe=u,i=Tt(c),u=i):(se=u,u=W)):(se=u,u=W)):(se=u,u=W),u===W&&(u=se,r.substr(se,3)===Ot?(i=Ot,se+=3):(i=W,0===de&&a(St)),i!==W&&(fe=u,i=Ht()),(u=i)===W&&(u=se,r.substr(se,4)===Nt?(i=Nt,se+=4):(i=W,0===de&&a(Rt)),i!==W&&(fe=u,i=Gt()),(u=i)===W&&(u=se,r.substr(se,4)===Yt?(i=Yt,se+=4):(i=W,0===de&&a(Bt)),i!==W&&(fe=u,i=Pt()),(u=i)===W&&(u=se,12391===r.charCodeAt(se)?(i=pt,se++):(i=W,0===de&&a(dt)),i===W&&(i=null),i!==W?(35440===r.charCodeAt(se)?(c=_t,se++):(c=W,0===de&&a(Lt)),c!==W?(12415===r.charCodeAt(se)?(s=jt,se++):(s=W,0===de&&a(Wt)),s===W&&(s=null),s!==W?(fe=u,i=Dt(),u=i):(se=u,u=W)):(se=u,u=W)):(se=u,u=W),u===W&&(u=se,r.substr(se,3)===zt?(i=zt,se+=3):(i=W,0===de&&a(Jt)),i!==W&&(fe=u,i=Vt()),u=i)))))),u!==W?(i=M(),i!==W?(fe=t,e=Zt(u),t=e):(se=t,t=W)):(se=t,t=W)):(se=t,t=W)):(se=t,t=W)}else se=t,t=W;return t}function b(){var t,e,o,n,u,i,c;if(t=se,r.substr(se,3)===$t?(e=$t,se+=3):(e=W,0===de&&a(qt)),e!==W){for(o=[],32===r.charCodeAt(se)?(n=nr,se++):(n=W,0===de&&a(ur));n!==W;)o.push(n),32===r.charCodeAt(se)?(n=nr,se++):(n=W,0===de&&a(ur));if(o!==W){if(n=[],st.test(r.charAt(se))?(u=r.charAt(se),se++):(u=W,0===de&&a(ft)),u!==W)for(;u!==W;)n.push(u),st.test(r.charAt(se))?(u=r.charAt(se),se++):(u=W,0===de&&a(ft));else n=W;n!==W?(25163===r.charCodeAt(se)?(u=lt,se++):(u=W,0===de&&a(ht)),u!==W?(i=M(),i!==W?(c=d(),c!==W?(fe=t,e=Qt(n,c),t=e):(se=t,t=W)):(se=t,t=W)):(se=t,t=W)):(se=t,t=W)}else se=t,t=W}else se=t,t=W;return t}function w(){var t;return X.test(r.charAt(se))?(t=r.charAt(se),se++):(t=W,0===de&&a(rr)),t}function M(){var r,t,e,o;if(r=se,t=[],(e=S())!==W)for(;e!==W;)t.push(e),e=S();else t=W;if(t!==W){for(e=[],o=T();o!==W;)e.push(o),o=T();e!==W?(t=[t,e],r=t):(se=r,r=W)}else se=r,r=W;return r}function T(){var t,e,o,n;if(t=se,35===r.charCodeAt(se)?(e=Xt,se++):(e=W,0===de&&a(re)),e!==W){for(o=[],n=H();n!==W;)o.push(n),n=H();o!==W?(n=S(),n!==W?(e=[e,o,n],t=e):(se=t,t=W)):(se=t,t=W)}else se=t,t=W;return t}function O(){var t;return 32===r.charCodeAt(se)?(t=nr,se++):(t=W,0===de&&a(ur)),t===W&&(9===r.charCodeAt(se)?(t=te,se++):(t=W,0===de&&a(ee))),t}function S(){var t,e,o,n,u;for(t=se,e=[],o=O();o!==W;)e.push(o),o=O();return e!==W?(10===r.charCodeAt(se)?(o=oe,se++):(o=W,0===de&&a(ne)),o===W&&(o=se,13===r.charCodeAt(se)?(n=ue,se++):(n=W,0===de&&a(ie)),n!==W?(10===r.charCodeAt(se)?(u=oe,se++):(u=W,0===de&&a(ne)),u===W&&(u=null),u!==W?(n=[n,u],o=n):(se=o,o=W)):(se=o,o=W)),o!==W?(e=[e,o],t=e):(se=t,t=W)):(se=t,t=W),t}function H(){var t;return ae.test(r.charAt(se))?(t=r.charAt(se),se++):(t=W,0===de&&a(ce)),t}function N(r){return"０１２３４５６７８９".indexOf(r)}function R(r){return"〇一二三四五六七八九".indexOf(r)}function G(r){switch(r.length){case 1:return"〇一二三四五六七八九十".indexOf(r);case 2:return"〇一二三四五六七八九十".indexOf(r[1])+10;default:throw"21以上の数値に対応していません"}}function Y(r){return"成"==r[0]?{"香":"NY","桂":"NK","銀":"NG"}[r[1]]:{"歩":"FU","香":"KY","桂":"KE","銀":"GI","金":"KI","角":"KA","飛":"HI","玉":"OU","王":"OU","と":"TO","杏":"NY","圭":"NK","全":"NG","馬":"UM","竜":"RY","龍":"RY"}[r]}function B(r){return{"左":"L","直":"C","右":"R"}[r]||""}function P(r){return{"上":"U","寄":"M","引":"D"}[r]||""}function _(r){return{"平手":"HIRATE","香落ち":"KY","右香落ち":"KY_R","角落ち":"KA","飛車落ち":"HI","飛香落ち":"HIKY","二枚落ち":"2","三枚落ち":"3","四枚落ち":"4","五枚落ち":"5","左五枚落ち":"5_L","六枚落ち":"6","八枚落ち":"8","十枚落ち":"10","その他":"OTHER"}[r.replace(/\s/g,"")]}function L(r){var t=r.replace(/　$/,"").split("　"),e={FU:0,KY:0,KE:0,GI:0,KI:0,KA:0,HI:0};if(""==r)return e;for(var o=0;o<t.length;o++)e[Y(t[o][0])]=1==t[o].length?1:G(t[o].slice(1));return e}t=void 0!==t?t:{};var j,W={},D={kifu:c},z=c,J=function(r,t,e,o,n){for(var u={header:{},moves:o},i=0;i<r.length;i++)u.header[r[i].k]=r[i].v;for(var i=0;i<e.length;i++)u.header[e[i].k]=e[i].v;if(t)u.initial=t;else if(u.header["手合割"]){var a=_(u.header["手合割"]);"OTHER"!=a&&(u.initial={preset:a})}u.initial&&u.initial.data&&(u.header["手番"]?(u.initial.data.color="下先".indexOf(u.header["手番"])>=0?0:1,delete u.header["手番"]):u.initial.data.color=0,u.initial.data.hands=[L(u.header["先手の持駒"]||u.header["下手の持駒"]),L(u.header["後手の持駒"]||u.header["上手の持駒"])],delete u.header["先手の持駒"],delete u.header["下手の持駒"],delete u.header["後手の持駒"],delete u.header["上手の持駒"]);for(var c=[{te:0,moves:o}],i=0;i<n.length;i++){for(var s=n[i],f=c.pop();f.te>=s.te;)f=c.pop();var l=f.moves[s.te-f.te];l.forks=l.forks||[],l.forks.push(s.moves),c.push(f),c.push(s)}return u},V=/^[^\uFF1A\r\n]/,Z=n(["：","\r","\n"],!0,!1),$="：",q=e("：",!1),Q=function(r,t){return{k:r.join(""),v:t.join("")}},X=/^[\u5148\u5F8C\u4E0A\u4E0B]/,rr=n(["先","後","上","下"],!1,!1),tr="手番",er=e("手番",!1),or=function(r){return{k:"手番",v:r}},nr=" ",ur=e(" ",!1),ir="+",ar=e("+",!1),cr=function(r){for(var t=[],e=0;e<9;e++){for(var o=[],n=0;n<9;n++)o.push(r[n][8-e]);t.push(o)}return{preset:"OTHER",data:{board:t}}},sr="|",fr=e("|",!1),lr=function(r){return r},hr=function(r,t){return{color:r,kind:t}},pr=" ・",dr=e(" ・",!1),vr=function(){return{}},mr="^",gr=e("^",!1),Ar=function(){return 0},kr="v",yr=e("v",!1),Kr="V",Ir=e("V",!1),Cr=function(){return 1},Fr=function(r,t,e){return t.unshift(r),e&&!t[t.length-1].special&&t.push({special:e}),t},xr=function(r){return 0==r.length?{}:{comments:r}},Er=function(r,t){var e={move:r};return t.length>0&&(e.comments=t),e},Ur="&",br=e("&",!1),wr=/^[\u25B2\u25B3]/,Mr=n(["▲","△"],!1,!1),Tr=function(r){return r},Or="成",Sr=e("成",!1),Hr="不成",Nr=e("不成",!1),Rr="打",Gr=e("打",!1),Yr=function(r,t,e,o,n,u){var i={piece:t};if(r.same?i.same=!0:i.to=r,n&&(i.promote="成"==n),u)i.relative="H";else{var a=B(e)+P(o);""!=a&&(i.relative=a)}return i},Br=function(r,t){return{x:r,y:t}},Pr="同",_r=e("同",!1),Lr="　",jr=e("　",!1),Wr=function(){return{same:!0}},Dr=/^[\u6B69\u9999\u6842\u9280\u91D1\u89D2\u98DB\u738B\u7389\u3068\u674F\u572D\u5168\u99AC\u7ADC\u9F8D]/,zr=n(["歩","香","桂","銀","金","角","飛","王","玉","と","杏","圭","全","馬","竜","龍"],!1,!1),Jr=function(r,t){return Y((r||"")+t)},Vr=/^[\u5DE6\u76F4\u53F3]/,Zr=n(["左","直","右"],!1,!1),$r=/^[\u4E0A\u5BC4\u5F15]/,qr=n(["上","寄","引"],!1,!1),Qr=/^[\uFF11\uFF12\uFF13\uFF14\uFF15\uFF16\uFF17\uFF18\uFF19]/,Xr=n(["１","２","３","４","５","６","７","８","９"],!1,!1),rt=function(r){return N(r)},tt=/^[\u4E00\u4E8C\u4E09\u56DB\u4E94\u516D\u4E03\u516B\u4E5D]/,et=n(["一","二","三","四","五","六","七","八","九"],!1,!1),ot=function(r){return R(r)},nt="*",ut=e("*",!1),it=function(r){return r.join("")},at="まで",ct=e("まで",!1),st=/^[0-9]/,ft=n([["0","9"]],!1,!1),lt="手",ht=e("手",!1),pt="で",dt=e("で",!1),vt="手の",mt=e("手の",!1),gt="勝ち",At=e("勝ち",!1),kt=function(r){return"TORYO"},yt="反則",Kt=e("反則",!1),It=function(r){return"ILLEGAL_ACTION"},Ct="負け",Ft=e("負け",!1),xt=function(r){return"ILLEGAL_MOVE"},Et=function(r,t){return t},Ut="で時間切れにより",bt=e("で時間切れにより",!1),wt="手の勝ち",Mt=e("手の勝ち",!1),Tt=function(r){return"TIME_UP"},Ot="で中断",St=e("で中断",!1),Ht=function(){return"CHUDAN"},Nt="で持将棋",Rt=e("で持将棋",!1),Gt=function(){return"JISHOGI"},Yt="で千日手",Bt=e("で千日手",!1),Pt=function(){return"SENNICHITE"},_t="詰",Lt=e("詰",!1),jt="み",Wt=e("み",!1),Dt=function(){return"TSUMI"},zt="で不詰",Jt=e("で不詰",!1),Vt=function(){return"FUZUMI"},Zt=function(r){return r},$t="変化：",qt=e("変化：",!1),Qt=function(r,t){return{te:parseInt(r.join("")),moves:t.slice(1)}},Xt="#",re=e("#",!1),te="\t",ee=e("\t",!1),oe="\n",ne=e("\n",!1),ue="\r",ie=e("\r",!1),ae=/^[^\r\n]/,ce=n(["\r","\n"],!0,!1),se=0,fe=0,le=[{line:1,column:1}],he=0,pe=[],de=0;if("startRule"in t){if(!(t.startRule in D))throw new Error("Can't start parsing from rule \""+t.startRule+'".');z=D[t.startRule]}if((j=z())!==W&&se===r.length)return j;throw j!==W&&se<r.length&&a(function(){return{type:"end"}}()),function(r,t,e){return new o(o.buildMessage(r,t),r,t,e)}(pe,he<r.length?r.charAt(he):null,he<r.length?i(he,he+1):i(he,he))}!function(r,t){function e(){this.constructor=r}e.prototype=t.prototype,r.prototype=new e}(o,Error),o.buildMessage=function(r,t){function e(r){return r.charCodeAt(0).toString(16).toUpperCase()}function o(r){return r.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(r){return"\\x0"+e(r)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(r){return"\\x"+e(r)})}function n(r){return r.replace(/\\/g,"\\\\").replace(/\]/g,"\\]").replace(/\^/g,"\\^").replace(/-/g,"\\-").replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(r){return"\\x0"+e(r)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(r){return"\\x"+e(r)})}function u(r){return i[r.type](r)}var i={literal:function(r){return'"'+o(r.text)+'"'},class:function(r){var t,e="";for(t=0;t<r.parts.length;t++)e+=r.parts[t]instanceof Array?n(r.parts[t][0])+"-"+n(r.parts[t][1]):n(r.parts[t]);return"["+(r.inverted?"^":"")+e+"]"},any:function(r){return"any character"},end:function(r){return"end of input"},other:function(r){return r.description}};return"Expected "+function(r){var t,e,o=new Array(r.length);for(t=0;t<r.length;t++)o[t]=u(r[t]);if(o.sort(),o.length>0){for(t=1,e=1;t<o.length;t++)o[t-1]!==o[t]&&(o[e]=o[t],e++);o.length=e}switch(o.length){case 1:return o[0];case 2:return o[0]+" or "+o[1];default:return o.slice(0,-1).join(", ")+", or "+o[o.length-1]}}(r)+" but "+function(r){return r?'"'+o(r)+'"':"end of input"}(t)+" found."},r.exports={SyntaxError:o,parse:n}},function(r,t,e){"use strict";function o(r,t,e,n){this.message=r,this.expected=t,this.found=e,this.location=n,this.name="SyntaxError","function"==typeof Error.captureStackTrace&&Error.captureStackTrace(this,o)}function n(r,t){function e(r,t){return{type:"literal",text:r,ignoreCase:t}}function n(r,t,e){return{type:"class",parts:r,inverted:t,ignoreCase:e}}function u(t){var e,o=Me[t];if(o)return o;for(e=t-1;!Me[e];)e--;for(o=Me[e],o={line:o.line,column:o.column};e<t;)10===r.charCodeAt(e)?(o.line++,o.column=1):o.column++,e++;return Me[t]=o,o}function i(r,t){var e=u(r),o=u(t);return{start:{offset:r,line:e.line,column:e.column},end:{offset:t,line:o.line,column:o.column}}}function a(r){be<Te||(be>Te&&(Te=be,Oe=[]),Oe.push(r))}function c(){var r,t,e,o,n,u,i,a,c;for(r=be,t=[],e=N();e!==V;)t.push(e),e=N();if(t!==V){for(e=[],o=s();o!==V;)e.push(o),o=s();if(e!==V)if(o=l(),o===V&&(o=null),o!==V){for(n=[],u=s();u!==V;)n.push(u),u=s();if(n!==V)if(u=v(),u===V&&(u=null),u!==V)if((i=m())!==V){for(a=[],c=S();c!==V;)a.push(c),c=S();a!==V?(c=H(),c===V&&(c=null),c!==V?(we=r,t=q(e,o,n,i,a),r=t):(be=r,r=V)):(be=r,r=V)}else be=r,r=V;else be=r,r=V;else be=r,r=V}else be=r,r=V;else be=r,r=V}else be=r,r=V;return r}function s(){var t,e,o,n,u;if(t=be,e=[],Q.test(r.charAt(be))?(o=r.charAt(be),be++):(o=V,0===Se&&a(X)),o!==V)for(;o!==V;)e.push(o),Q.test(r.charAt(be))?(o=r.charAt(be),be++):(o=V,0===Se&&a(X));else e=V;if(e!==V)if(65306===r.charCodeAt(be)?(o=rr,be++):(o=V,0===Se&&a(tr)),o!==V){for(n=[],u=Y();u!==V;)n.push(u),u=Y();n!==V?(u=H(),u!==V?(we=t,e=er(e,n),t=e):(be=t,t=V)):(be=t,t=V)}else be=t,t=V;else be=t,t=V;return t===V&&(t=be,e=f(),e!==V?(r.substr(be,2)===or?(o=or,be+=2):(o=V,0===Se&&a(nr)),o!==V?(n=H(),n!==V?(we=t,e=ur(e),t=e):(be=t,t=V)):(be=t,t=V)):(be=t,t=V),t===V&&(t=be,r.substr(be,4)===ir?(e=ir,be+=4):(e=V,0===Se&&a(ar)),e!==V?(o=H(),o!==V?(we=t,e=cr(),t=e):(be=t,t=V)):(be=t,t=V))),t}function f(){var t;return sr.test(r.charAt(be))?(t=r.charAt(be),be++):(t=V,0===Se&&a(fr)),t}function l(){var t,e,o,n,u,i,c,s;if(t=be,e=be,32===r.charCodeAt(be)?(o=lr,be++):(o=V,0===Se&&a(hr)),o!==V){for(n=[],u=Y();u!==V;)n.push(u),u=Y();n!==V?(u=H(),u!==V?(o=[o,n,u],e=o):(be=e,e=V)):(be=e,e=V)}else be=e,e=V;if(e===V&&(e=null),e!==V){if(o=be,43===r.charCodeAt(be)?(n=pr,be++):(n=V,0===Se&&a(dr)),n!==V){for(u=[],i=Y();i!==V;)u.push(i),i=Y();u!==V?(i=H(),i!==V?(n=[n,u,i],o=n):(be=o,o=V)):(be=o,o=V)}else be=o,o=V;if(o===V&&(o=null),o!==V){if(n=[],(u=h())!==V)for(;u!==V;)n.push(u),u=h();else n=V;if(n!==V){if(u=be,43===r.charCodeAt(be)?(i=pr,be++):(i=V,0===Se&&a(dr)),i!==V){for(c=[],s=Y();s!==V;)c.push(s),s=Y();c!==V?(s=H(),s!==V?(i=[i,c,s],u=i):(be=u,u=V)):(be=u,u=V)}else be=u,u=V;u===V&&(u=null),u!==V?(we=t,e=vr(n),t=e):(be=t,t=V)}else be=t,t=V}else be=t,t=V}else be=t,t=V;return t}function h(){var t,e,o,n,u,i;if(t=be,124===r.charCodeAt(be)?(e=mr,be++):(e=V,0===Se&&a(gr)),e!==V){if(o=[],(n=p())!==V)for(;n!==V;)o.push(n),n=p();else o=V;if(o!==V)if(124===r.charCodeAt(be)?(n=mr,be++):(n=V,0===Se&&a(gr)),n!==V){if(u=[],(i=Y())!==V)for(;i!==V;)u.push(i),i=Y();else u=V;u!==V?(i=H(),i!==V?(we=t,e=Ar(o),t=e):(be=t,t=V)):(be=t,t=V)}else be=t,t=V;else be=t,t=V}else be=t,t=V;return t}function p(){var t,e,o;return t=be,e=d(),e!==V?(o=E(),o!==V?(we=t,e=kr(e,o),t=e):(be=t,t=V)):(be=t,t=V),t===V&&(t=be,r.substr(be,2)===yr?(e=yr,be+=2):(e=V,0===Se&&a(Kr)),e!==V&&(we=t,e=Ir()),t=e),t}function d(){var t,e;return t=be,32===r.charCodeAt(be)?(e=lr,be++):(e=V,0===Se&&a(hr)),e===V&&(43===r.charCodeAt(be)?(e=pr,be++):(e=V,0===Se&&a(dr)),e===V&&(94===r.charCodeAt(be)?(e=Cr,be++):(e=V,0===Se&&a(Fr)))),e!==V&&(we=t,e=xr()),t=e,t===V&&(t=be,118===r.charCodeAt(be)?(e=Er,be++):(e=V,0===Se&&a(Ur)),e===V&&(86===r.charCodeAt(be)?(e=br,be++):(e=V,0===Se&&a(wr))),e!==V&&(we=t,e=Mr()),t=e),t}function v(){var t,e,o,n;return t=be,r.substr(be,10)===Tr?(e=Tr,be+=10):(e=V,0===Se&&a(Or)),e!==V?(r.substr(be,13)===Sr?(o=Sr,be+=13):(o=V,0===Se&&a(Hr)),o===V&&(o=null),o!==V?(n=H(),n!==V?(e=[e,o,n],t=e):(be=t,t=V)):(be=t,t=V)):(be=t,t=V),t}function m(){var r,t,e,o,n;if(r=be,(t=g())!==V)if(e=v(),e===V&&(e=null),e!==V){for(o=[],n=A();n!==V;)o.push(n),n=A();o!==V?(n=O(),n===V&&(n=null),n!==V?(we=r,t=Nr(t,o),r=t):(be=r,r=V)):(be=r,r=V)}else be=r,r=V;else be=r,r=V;return r}function g(){var r,t,e;for(r=be,t=[],e=T();e!==V;)t.push(e),e=T();return t!==V?(e=k(),e===V&&(e=null),e!==V?(we=r,t=Rr(t),r=t):(be=r,r=V)):(be=r,r=V),r}function A(){var r,t,e,o;if(r=be,(t=y())!==V){for(e=[],o=T();o!==V;)e.push(o),o=T();e!==V?(o=k(),o===V&&(o=null),o!==V?(we=r,t=Gr(t,e),r=t):(be=r,r=V)):(be=r,r=V)}else be=r,r=V;return r}function k(){var t,e,o,n;if(t=be,38===r.charCodeAt(be)?(e=Yr,be++):(e=V,0===Se&&a(Br)),e!==V){for(o=[],n=Y();n!==V;)o.push(n),n=Y();o!==V?(n=H(),n!==V?(e=[e,o,n],t=e):(be=t,t=V)):(be=t,t=V)}else be=t,t=V;return t}function y(){var t,e,o,n,u,i,c,s,f;for(t=be,e=[],32===r.charCodeAt(be)?(o=lr,be++):(o=V,0===Se&&a(hr));o!==V;)e.push(o),32===r.charCodeAt(be)?(o=lr,be++):(o=V,0===Se&&a(hr));if(e!==V)if((o=K())!==V){for(n=[],32===r.charCodeAt(be)?(u=lr,be++):(u=V,0===Se&&a(hr));u!==V;)n.push(u),32===r.charCodeAt(be)?(u=lr,be++):(u=V,0===Se&&a(hr));if(n!==V){if(u=be,i=I(),i!==V?(c=U(),c!==V?(we=u,i=Pr(i,c),u=i):(be=u,u=V)):(be=u,u=V),u===V){for(u=be,i=[],_r.test(r.charAt(be))?(c=r.charAt(be),be++):(c=V,0===Se&&a(Lr));c!==V;)i.push(c),_r.test(r.charAt(be))?(c=r.charAt(be),be++):(c=V,0===Se&&a(Lr));i!==V&&(we=u,i=jr(i)),u=i}if(u!==V){for(i=[],32===r.charCodeAt(be)?(c=lr,be++):(c=V,0===Se&&a(hr));c!==V;)i.push(c),32===r.charCodeAt(be)?(c=lr,be++):(c=V,0===Se&&a(hr));i!==V?(c=b(),c===V&&(c=null),c!==V?(43===r.charCodeAt(be)?(s=pr,be++):(s=V,0===Se&&a(dr)),s===V&&(s=null),s!==V?(f=H(),f!==V?(we=t,e=Wr(u,c),t=e):(be=t,t=V)):(be=t,t=V)):(be=t,t=V)):(be=t,t=V)}else be=t,t=V}else be=t,t=V}else be=t,t=V;else be=t,t=V;return t}function K(){var t,e;if(t=[],Dr.test(r.charAt(be))?(e=r.charAt(be),be++):(e=V,0===Se&&a(zr)),e!==V)for(;e!==V;)t.push(e),Dr.test(r.charAt(be))?(e=r.charAt(be),be++):(e=V,0===Se&&a(zr));else t=V;return t}function I(){var t,e,o,n;return t=be,e=C(),e!==V?(o=E(),o!==V?(25104===r.charCodeAt(be)?(n=Jr,be++):(n=V,0===Se&&a(Vr)),n===V&&(n=null),n!==V?(we=t,e=Zr(e,o,n),t=e):(be=t,t=V)):(be=t,t=V)):(be=t,t=V),t}function C(){var t,e,o;return t=be,e=F(),e!==V?(o=x(),o!==V?(we=t,e=$r(e,o),t=e):(be=t,t=V)):(be=t,t=V),t===V&&(t=be,r.substr(be,2)===qr?(e=qr,be+=2):(e=V,0===Se&&a(Qr)),e!==V&&(we=t,e=cr()),t=e),t}function F(){var t,e;return t=be,Xr.test(r.charAt(be))?(e=r.charAt(be),be++):(e=V,0===Se&&a(rt)),e!==V&&(we=t,e=tt(e)),t=e}function x(){var t,e;return t=be,et.test(r.charAt(be))?(e=r.charAt(be),be++):(e=V,0===Se&&a(ot)),e!==V&&(we=t,e=nt(e)),t=e}function E(){var t,e,o;return t=be,25104===r.charCodeAt(be)?(e=Jr,be++):(e=V,0===Se&&a(Vr)),e===V&&(e=null),e!==V?(ut.test(r.charAt(be))?(o=r.charAt(be),be++):(o=V,0===Se&&a(it)),o!==V?(we=t,e=at(e,o),t=e):(be=t,t=V)):(be=t,t=V),t}function U(){var t,e,o,n,u;return t=be,25171===r.charCodeAt(be)?(e=ct,be++):(e=V,0===Se&&a(st)),e!==V&&(we=t,e=cr()),t=e,t===V&&(t=be,40===r.charCodeAt(be)?(e=ft,be++):(e=V,0===Se&&a(lt)),e!==V?(ht.test(r.charAt(be))?(o=r.charAt(be),be++):(o=V,0===Se&&a(pt)),o!==V?(ht.test(r.charAt(be))?(n=r.charAt(be),be++):(n=V,0===Se&&a(pt)),n!==V?(41===r.charCodeAt(be)?(u=dt,be++):(u=V,0===Se&&a(vt)),u!==V?(we=t,e=mt(o,n),t=e):(be=t,t=V)):(be=t,t=V)):(be=t,t=V)):(be=t,t=V)),t}function b(){var t,e,o,n,u,i,c;if(t=be,40===r.charCodeAt(be)?(e=ft,be++):(e=V,0===Se&&a(lt)),e!==V){for(o=[],32===r.charCodeAt(be)?(n=lr,be++):(n=V,0===Se&&a(hr));n!==V;)o.push(n),32===r.charCodeAt(be)?(n=lr,be++):(n=V,0===Se&&a(hr));o!==V?(n=M(),n!==V?(47===r.charCodeAt(be)?(u=gt,be++):(u=V,0===Se&&a(At)),u!==V?(i=w(),i!==V?(41===r.charCodeAt(be)?(c=dt,be++):(c=V,0===Se&&a(vt)),c!==V?(we=t,e=kt(n,i),t=e):(be=t,t=V)):(be=t,t=V)):(be=t,t=V)):(be=t,t=V)):(be=t,t=V)}else be=t,t=V;return t}function w(){var t,e,o,n,u,i,c;if(t=be,e=[],Dr.test(r.charAt(be))?(o=r.charAt(be),be++):(o=V,0===Se&&a(zr)),o!==V)for(;o!==V;)e.push(o),Dr.test(r.charAt(be))?(o=r.charAt(be),be++):(o=V,0===Se&&a(zr));else e=V;if(e!==V)if(58===r.charCodeAt(be)?(o=yt,be++):(o=V,0===Se&&a(Kt)),o!==V){if(n=[],Dr.test(r.charAt(be))?(u=r.charAt(be),be++):(u=V,0===Se&&a(zr)),u!==V)for(;u!==V;)n.push(u),Dr.test(r.charAt(be))?(u=r.charAt(be),be++):(u=V,0===Se&&a(zr));else n=V;if(n!==V)if(58===r.charCodeAt(be)?(u=yt,be++):(u=V,0===Se&&a(Kt)),u!==V){if(i=[],Dr.test(r.charAt(be))?(c=r.charAt(be),be++):(c=V,0===Se&&a(zr)),c!==V)for(;c!==V;)i.push(c),Dr.test(r.charAt(be))?(c=r.charAt(be),be++):(c=V,0===Se&&a(zr));else i=V;i!==V?(we=t,e=It(e,n,i),t=e):(be=t,t=V)}else be=t,t=V;else be=t,t=V}else be=t,t=V;else be=t,t=V;return t}function M(){var t,e,o,n,u;if(t=be,e=[],Dr.test(r.charAt(be))?(o=r.charAt(be),be++):(o=V,0===Se&&a(zr)),o!==V)for(;o!==V;)e.push(o),Dr.test(r.charAt(be))?(o=r.charAt(be),be++):(o=V,0===Se&&a(zr));else e=V;if(e!==V)if(58===r.charCodeAt(be)?(o=yt,be++):(o=V,0===Se&&a(Kt)),o!==V){if(n=[],Dr.test(r.charAt(be))?(u=r.charAt(be),be++):(u=V,0===Se&&a(zr)),u!==V)for(;u!==V;)n.push(u),Dr.test(r.charAt(be))?(u=r.charAt(be),be++):(u=V,0===Se&&a(zr));else n=V;n!==V?(we=t,e=Ct(e,n),t=e):(be=t,t=V)}else be=t,t=V;else be=t,t=V;return t}function T(){var t,e,o,n;if(t=be,42===r.charCodeAt(be)?(e=Ft,be++):(e=V,0===Se&&a(xt)),e!==V){for(o=[],n=Y();n!==V;)o.push(n),n=Y();o!==V?(n=H(),n!==V?(we=t,e=Et(o),t=e):(be=t,t=V)):(be=t,t=V)}else be=t,t=V;if(t===V)if(t=be,38===r.charCodeAt(be)?(e=Yr,be++):(e=V,0===Se&&a(Br)),e!==V){for(o=[],n=Y();n!==V;)o.push(n),n=Y();o!==V?(n=H(),n!==V?(we=t,e=Ut(o),t=e):(be=t,t=V)):(be=t,t=V)}else be=t,t=V;return t}function O(){var t,e,o,n,u,i,c,s,l,h,p,d;if(t=be,r.substr(be,2)===bt?(e=bt,be+=2):(e=V,0===Se&&a(wt)),e!==V){if(o=[],Dr.test(r.charAt(be))?(n=r.charAt(be),be++):(n=V,0===Se&&a(zr)),n!==V)for(;n!==V;)o.push(n),Dr.test(r.charAt(be))?(n=r.charAt(be),be++):(n=V,0===Se&&a(zr));else o=V;o!==V?(25163===r.charCodeAt(be)?(n=Mt,be++):(n=V,0===Se&&a(Tt)),n!==V?(u=be,12391===r.charCodeAt(be)?(i=Ot,be++):(i=V,0===Se&&a(St)),i!==V?(c=f(),c!==V?(r.substr(be,2)===Ht?(s=Ht,be+=2):(s=V,0===Se&&a(Nt)),s!==V?(l=be,r.substr(be,2)===Rt?(h=Rt,be+=2):(h=V,0===Se&&a(Gt)),h!==V&&(we=l,h=Yt(c)),l=h,l===V&&(l=be,r.substr(be,2)===Bt?(h=Bt,be+=2):(h=V,0===Se&&a(Pt)),h!==V?(p=be,r.substr(be,2)===Rt?(d=Rt,be+=2):(d=V,0===Se&&a(Gt)),d!==V&&(we=p,d=_t(c)),p=d,p===V&&(p=be,r.substr(be,2)===Lt?(d=Lt,be+=2):(d=V,0===Se&&a(jt)),d!==V&&(we=p,d=Wt(c)),p=d),p!==V?(we=l,h=Dt(c,p),l=h):(be=l,l=V)):(be=l,l=V)),l!==V?(we=u,i=Dt(c,l),u=i):(be=u,u=V)):(be=u,u=V)):(be=u,u=V)):(be=u,u=V),u===V&&(u=be,r.substr(be,8)===zt?(i=zt,be+=8):(i=V,0===Se&&a(Jt)),i!==V?(c=f(),c!==V?(r.substr(be,4)===Vt?(s=Vt,be+=4):(s=V,0===Se&&a(Zt)),s!==V?(we=u,i=$t(c),u=i):(be=u,u=V)):(be=u,u=V)):(be=u,u=V),u===V&&(u=be,r.substr(be,3)===qt?(i=qt,be+=3):(i=V,0===Se&&a(Qt)),i!==V&&(we=u,i=Xt()),(u=i)===V&&(u=be,r.substr(be,4)===re?(i=re,be+=4):(i=V,0===Se&&a(te)),i!==V&&(we=u,i=ee()),(u=i)===V&&(u=be,r.substr(be,4)===oe?(i=oe,be+=4):(i=V,0===Se&&a(ne)),i!==V&&(we=u,i=ue()),(u=i)===V&&(u=be,12391===r.charCodeAt(be)?(i=Ot,be++):(i=V,0===Se&&a(St)),i===V&&(i=null),i!==V?(35440===r.charCodeAt(be)?(c=ie,be++):(c=V,0===Se&&a(ae)),c!==V?(12415===r.charCodeAt(be)?(s=ce,be++):(s=V,0===Se&&a(se)),s===V&&(s=null),s!==V?(we=u,i=fe(),u=i):(be=u,u=V)):(be=u,u=V)):(be=u,u=V),u===V&&(u=be,r.substr(be,3)===le?(i=le,be+=3):(i=V,0===Se&&a(he)),i!==V&&(we=u,i=pe()),u=i)))))),u!==V?(i=H(),i!==V?(we=t,e=de(u),t=e):(be=t,t=V)):(be=t,t=V)):(be=t,t=V)):(be=t,t=V)}else be=t,t=V;return t}function S(){var t,e,o,n,u,i,c;if(t=be,r.substr(be,3)===ve?(e=ve,be+=3):(e=V,0===Se&&a(me)),e!==V){for(o=[],32===r.charCodeAt(be)?(n=lr,be++):(n=V,0===Se&&a(hr));n!==V;)o.push(n),32===r.charCodeAt(be)?(n=lr,be++):(n=V,0===Se&&a(hr));if(o!==V){if(n=[],Dr.test(r.charAt(be))?(u=r.charAt(be),be++):(u=V,0===Se&&a(zr)),u!==V)for(;u!==V;)n.push(u),Dr.test(r.charAt(be))?(u=r.charAt(be),be++):(u=V,0===Se&&a(zr));else n=V;n!==V?(25163===r.charCodeAt(be)?(u=Mt,be++):(u=V,0===Se&&a(Tt)),u!==V?(i=H(),i!==V?(c=m(),c!==V?(we=t,e=ge(n,c),t=e):(be=t,t=V)):(be=t,t=V)):(be=t,t=V)):(be=t,t=V)}else be=t,t=V}else be=t,t=V;return t}function H(){var r,t,e,o;if(r=be,t=[],(e=G())!==V)for(;e!==V;)t.push(e),e=G();else t=V;if(t!==V){for(e=[],o=N();o!==V;)e.push(o),o=N();e!==V?(t=[t,e],r=t):(be=r,r=V)}else be=r,r=V;return r}function N(){var t,e,o,n;if(t=be,35===r.charCodeAt(be)?(e=Ae,be++):(e=V,0===Se&&a(ke)),e!==V){for(o=[],n=Y();n!==V;)o.push(n),n=Y();o!==V?(n=G(),n!==V?(e=[e,o,n],t=e):(be=t,t=V)):(be=t,t=V)}else be=t,t=V;return t}function R(){var t;return 32===r.charCodeAt(be)?(t=lr,be++):(t=V,0===Se&&a(hr)),t===V&&(9===r.charCodeAt(be)?(t=ye,be++):(t=V,0===Se&&a(Ke))),t}function G(){var t,e,o,n,u;for(t=be,e=[],o=R();o!==V;)e.push(o),o=R();return e!==V?(10===r.charCodeAt(be)?(o=Ie,be++):(o=V,0===Se&&a(Ce)),o===V&&(o=be,13===r.charCodeAt(be)?(n=Fe,be++):(n=V,0===Se&&a(xe)),n!==V?(10===r.charCodeAt(be)?(u=Ie,be++):(u=V,0===Se&&a(Ce)),u===V&&(u=null),u!==V?(n=[n,u],o=n):(be=o,o=V)):(be=o,o=V)),o!==V?(e=[e,o],t=e):(be=t,t=V)):(be=t,t=V),t}function Y(){var t;return Ee.test(r.charAt(be))?(t=r.charAt(be),be++):(t=V,0===Se&&a(Ue)),t}function B(r){return parseInt(r.join(""),10)}function P(r){return"０１２３４５６７８９".indexOf(r)}function _(r){return"〇一二三四五六七八九".indexOf(r)}function L(r){switch(r.length){case 1:return"〇一二三四五六七八九十".indexOf(r);case 2:return"〇一二三四五六七八九十".indexOf(r[1])+10;default:throw"21以上の数値に対応していません"}}function j(r){return"成"==r[0]?{"香":"NY","桂":"NK","銀":"NG"}[r[1]]:{"歩":"FU","香":"KY","桂":"KE","銀":"GI","金":"KI","角":"KA","飛":"HI","玉":"OU","王":"OU","と":"TO","杏":"NY","圭":"NK","全":"NG","馬":"UM","竜":"RY","龍":"RY"}[r]}function W(r){return{"中断":"CHUDAN","投了":"TORYO","持将棋":"JISHOGI","千日手":"SENNICHITE","詰み":"TSUMI","不詰":"FUZUMI","切れ負け":"TIME_UP","反則勝ち":"ILLEGAL_ACTION","反則負け":"ILLEGAL_MOVE"}[r]}function D(r){return{"平手":"HIRATE","香落ち":"KY","右香落ち":"KY_R","角落ち":"KA","飛車落ち":"HI","飛香落ち":"HIKY","二枚落ち":"2","三枚落ち":"3","四枚落ち":"4","五枚落ち":"5","左五枚落ち":"5_L","六枚落ち":"6","八枚落ち":"8","十枚落ち":"10","その他":"OTHER"}[r.replace(/\s/g,"")]}function z(r){var t=r.split(/[ 　]/),e={FU:0,KY:0,KE:0,GI:0,KI:0,KA:0,HI:0};if(""==r)return e;for(var o=0;o<t.length;o++)""!=t[o]&&(e[j(t[o][0])]=1==t[o].length?1:L(t[o].slice(1)));return e}t=void 0!==t?t:{};var J,V={},Z={kifu:c},$=c,q=function(r,t,e,o,n){for(var u={header:{},moves:o},i=0;i<r.length;i++)r[i]&&(u.header[r[i].k]=r[i].v);for(var i=0;i<e.length;i++)e[i]&&(u.header[e[i].k]=e[i].v);if(t)u.initial=t;else if(u.header["手合割"]){var a=D(u.header["手合割"]);"OTHER"!=a&&(u.initial={preset:a})}u.initial&&u.initial.data&&(u.header["手番"]?(u.initial.data.color="下先".indexOf(u.header["手番"])>=0?0:1,delete u.header["手番"]):u.initial.data.color=0,u.initial.data.hands=[z(u.header["先手の持駒"]||u.header["下手の持駒"]),z(u.header["後手の持駒"]||u.header["上手の持駒"])],delete u.header["先手の持駒"],delete u.header["下手の持駒"],delete u.header["後手の持駒"],delete u.header["上手の持駒"]);for(var c=[{te:0,moves:o}],i=0;i<n.length;i++){for(var s=n[i],f=c.pop();f.te>=s.te;)f=c.pop();var l=f.moves[s.te-f.te];l.forks=l.forks||[],l.forks.push(s.moves),c.push(f),c.push(s)}return u},Q=/^[^\uFF1A\r\n]/,X=n(["：","\r","\n"],!0,!1),rr="：",tr=e("：",!1),er=function(r,t){return{k:r.join(""),v:t.join("")}},or="手番",nr=e("手番",!1),ur=function(r){return{k:"手番",v:r}},ir="盤面回転",ar=e("盤面回転",!1),cr=function(){return null},sr=/^[\u5148\u5F8C\u4E0A\u4E0B]/,fr=n(["先","後","上","下"],!1,!1),lr=" ",hr=e(" ",!1),pr="+",dr=e("+",!1),vr=function(r){for(var t=[],e=0;e<9;e++){for(var o=[],n=0;n<9;n++)o.push(r[n][8-e]);t.push(o)}return{preset:"OTHER",data:{board:t}}},mr="|",gr=e("|",!1),Ar=function(r){return r},kr=function(r,t){return{color:r,kind:t}},yr=" ・",Kr=e(" ・",!1),Ir=function(){return{}},Cr="^",Fr=e("^",!1),xr=function(){return 0},Er="v",Ur=e("v",!1),br="V",wr=e("V",!1),Mr=function(){return 1},Tr="手数----指手--",Or=e("手数----指手--",!1),Sr="-------消費時間--",Hr=e("-------消費時間--",!1),Nr=function(r,t){return t.unshift(r),t},Rr=function(r){return 0==r.length?{}:{comments:r}},Gr=function(r,t){var e={};return t.length>0&&(e.comments=t),"object"==typeof r.move?e.move=r.move:e.special=W(r.move),r.time&&(e.time=r.time),e},Yr="&",Br=e("&",!1),Pr=function(r,t){var e={piece:r.piece};return r.to?e.to=r.to:e.same=!0,r.promote&&(e.promote=!0),t&&(e.from=t),e},_r=/^[^\r\n ]/,Lr=n(["\r","\n"," "],!0,!1),jr=function(r){return r.join("")},Wr=function(r,t){return{move:r,time:t}},Dr=/^[0-9]/,zr=n([["0","9"]],!1,!1),Jr="成",Vr=e("成",!1),Zr=function(r,t,e){return{to:r,piece:t,promote:!!e}},$r=function(r,t){return{x:r,y:t}},qr="同　",Qr=e("同　",!1),Xr=/^[\uFF11\uFF12\uFF13\uFF14\uFF15\uFF16\uFF17\uFF18\uFF19]/,rt=n(["１","２","３","４","５","６","７","８","９"],!1,!1),tt=function(r){return P(r)},et=/^[\u4E00\u4E8C\u4E09\u56DB\u4E94\u516D\u4E03\u516B\u4E5D]/,ot=n(["一","二","三","四","五","六","七","八","九"],!1,!1),nt=function(r){return _(r)},ut=/^[\u6B69\u9999\u6842\u9280\u91D1\u89D2\u98DB\u738B\u7389\u3068\u674F\u572D\u5168\u99AC\u7ADC\u9F8D]/,it=n(["歩","香","桂","銀","金","角","飛","王","玉","と","杏","圭","全","馬","竜","龍"],!1,!1),at=function(r,t){return j((r||"")+t)},ct="打",st=e("打",!1),ft="(",lt=e("(",!1),ht=/^[1-9]/,pt=n([["1","9"]],!1,!1),dt=")",vt=e(")",!1),mt=function(r,t){return{x:parseInt(r),y:parseInt(t)}},gt="/",At=e("/",!1),kt=function(r,t){return{now:r,total:t}},yt=":",Kt=e(":",!1),It=function(r,t,e){return{h:B(r),m:B(t),s:B(e)}},Ct=function(r,t){return{m:B(r),s:B(t)}},Ft="*",xt=e("*",!1),Et=function(r){return r.join("")},Ut=function(r){return"&"+r.join("")},bt="まで",wt=e("まで",!1),Mt="手",Tt=e("手",!1),Ot="で",St=e("で",!1),Ht="手の",Nt=e("手の",!1),Rt="勝ち",Gt=e("勝ち",!1),Yt=function(r){return"TORYO"},Bt="反則",Pt=e("反則",!1),_t=function(r){return"ILLEGAL_ACTION"},Lt="負け",jt=e("負け",!1),Wt=function(r){return"ILLEGAL_MOVE"},Dt=function(r,t){return t},zt="で時間切れにより",Jt=e("で時間切れにより",!1),Vt="手の勝ち",Zt=e("手の勝ち",!1),$t=function(r){return"TIME_UP"},qt="で中断",Qt=e("で中断",!1),Xt=function(){return"CHUDAN"},re="で持将棋",te=e("で持将棋",!1),ee=function(){return"JISHOGI"},oe="で千日手",ne=e("で千日手",!1),ue=function(){return"SENNICHITE"},ie="詰",ae=e("詰",!1),ce="み",se=e("み",!1),fe=function(){return"TSUMI"},le="で不詰",he=e("で不詰",!1),pe=function(){return"FUZUMI"},de=function(r){return r},ve="変化：",me=e("変化：",!1),ge=function(r,t){return{te:parseInt(r.join("")),moves:t.slice(1)}},Ae="#",ke=e("#",!1),ye="\t",Ke=e("\t",!1),Ie="\n",Ce=e("\n",!1),Fe="\r",xe=e("\r",!1),Ee=/^[^\r\n]/,Ue=n(["\r","\n"],!0,!1),be=0,we=0,Me=[{line:1,column:1}],Te=0,Oe=[],Se=0;if("startRule"in t){if(!(t.startRule in Z))throw new Error("Can't start parsing from rule \""+t.startRule+'".');$=Z[t.startRule]}if((J=$())!==V&&be===r.length)return J;throw J!==V&&be<r.length&&a(function(){return{type:"end"}}()),function(r,t,e){return new o(o.buildMessage(r,t),r,t,e)}(Oe,Te<r.length?r.charAt(Te):null,Te<r.length?i(Te,Te+1):i(Te,Te))}!function(r,t){function e(){this.constructor=r}e.prototype=t.prototype,r.prototype=new e}(o,Error),o.buildMessage=function(r,t){function e(r){return r.charCodeAt(0).toString(16).toUpperCase()}function o(r){return r.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(r){return"\\x0"+e(r)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(r){return"\\x"+e(r)})}function n(r){return r.replace(/\\/g,"\\\\").replace(/\]/g,"\\]").replace(/\^/g,"\\^").replace(/-/g,"\\-").replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(r){return"\\x0"+e(r)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(r){return"\\x"+e(r)})}function u(r){return i[r.type](r)}var i={literal:function(r){return'"'+o(r.text)+'"'},class:function(r){var t,e="";for(t=0;t<r.parts.length;t++)e+=r.parts[t]instanceof Array?n(r.parts[t][0])+"-"+n(r.parts[t][1]):n(r.parts[t]);return"["+(r.inverted?"^":"")+e+"]"},any:function(r){return"any character"},end:function(r){return"end of input"},other:function(r){return r.description}};return"Expected "+function(r){var t,e,o=new Array(r.length);for(t=0;t<r.length;t++)o[t]=u(r[t]);if(o.sort(),o.length>0){for(t=1,e=1;t<o.length;t++)o[t-1]!==o[t]&&(o[e]=o[t],e++);o.length=e}switch(o.length){case 1:return o[0];case 2:return o[0]+" or "+o[1];default:return o.slice(0,-1).join(", ")+", or "+o[o.length-1]}}(r)+" but "+function(r){return r?'"'+o(r)+'"':"end of input"}(t)+" found."},r.exports={SyntaxError:o,parse:n}}]);